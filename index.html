<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ | Al Ikhlas Organization</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Light Mode (Default) */
            --primary: #1b5e20;
            --primary-light: #4c8c4a;
            --accent: #fbc02d;
            --bg-light: #f5f7fa;
            --bg-dark: #121212;
            --surface-light: #ffffff;
            --surface-dark: #1e1e1e;
            --text-light: #333333;
            --text-dark: #e0e0e0;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.1); 
            --radius: 20px;
            --danger: #d32f2f;
            --success: #2e7d32;
        }

        /* DARK MODE OVERRIDES */
        html.dark-mode {
            --bg-light: #18191a;  
            --surface-light: #242526; 
            --text-light: #e4e6eb;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
        }

        html.dark-mode .card { border: 1px solid rgba(255,255,255,0.05); }
        html.dark-mode header { background: var(--primary); } 
        html.dark-mode .nav-bar { background: #242526; border-top: 1px solid #3e4042; }
        html.dark-mode .msg.others { background: #3a3b3c; color: #e4e6eb; }
        html.dark-mode .msg.mine { background: #0084ff; color: white; }
        html.dark-mode input, html.dark-mode select, html.dark-mode textarea { background: #3a3b3c; color: white; border: 1px solid #3e4042; }
        html.dark-mode #messages-list { background: #18191a; }
        html.dark-mode .skeleton { background: linear-gradient(90deg, #2c2c2c, #3a3b3c, #2c2c2c); }

        /* RESET & BASE */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', 'Noto Sans Bengali', sans-serif; background-color: var(--bg-light); color: var(--text-light); transition: background-color 0.3s, color 0.3s; padding-bottom: 80px; }
        
        /* UTILITIES */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-primary { color: var(--primary); }
        .text-accent { color: var(--accent); }
        .text-red { color: var(--danger); }
        .text-green { color: var(--success); }
        
        /* CARD DESIGN */
        .card { 
            background: var(--surface-light); 
            border-radius: var(--radius); 
            padding: 1.2rem; 
            box-shadow: var(--shadow); 
            margin-bottom: 1rem; 
            border: 1px solid rgba(0,0,0,0.02); 
            position: relative; 
            transition: transform 0.2s, background-color 0.3s; 
        }
        .card:active { transform: scale(0.98); }
        
        /* HEADER & MENU */
        header { 
            background: linear-gradient(135deg, var(--primary), #0d3b10); 
            color: white; padding: 1rem; position: sticky; top: 0; z-index: 50; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        header h1 { font-size: 1.2rem; font-weight: 700; }
        
        /* UPDATED: Added position relative to parent for notification dot */
        .header-menu-btn { cursor: pointer; padding: 5px; font-size: 1.2rem; position: relative; }
        
        .dropdown-menu { position: absolute; top: 50px; right: 10px; background: var(--surface-light); color: var(--text-light); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 200px; display: none; flex-direction: column; overflow: hidden; z-index: 1000; border: 1px solid rgba(0,0,0,0.1); }
        .dropdown-menu.show { display: flex; animation: slideDown 0.2s ease; }
        .dropdown-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .dropdown-item:hover { background: rgba(0,0,0,0.05); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* AUTH SCREEN */
        #auth-screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; background: linear-gradient(135deg, var(--primary), #003300); }
        .auth-box { background: white; padding: 2rem; border-radius: var(--radius); width: 100%; max-width: 400px; text-align: center; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        
        /* FORM ELEMENTS */
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; font-family: inherit; background: var(--surface-light); color: var(--text-light); transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1); }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; margin-top: 10px; }
        button:active { transform: scale(0.98); }
        button.secondary { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        button.danger { background: var(--danger); color: white; border: none; }
        button.small-btn { width: auto; padding: 6px 12px; font-size: 0.8rem; }
        
        /* NAVIGATION */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface-light); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; transition: background-color 0.3s; border-radius: 20px 20px 0 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; color: #888; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }
        
        /* BADGES (Fixed Position) */
        .red-dot { position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: red; border-radius: 50%; border: 2px solid white; display: none; }
        .red-dot.visible { display: block; }
        .badge-count { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; display: none; }

        /* DASHBOARD GRID */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-bottom: 1rem; }
        .stat-card { background: var(--surface-light); padding: 1rem; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); border-left: 4px solid var(--accent); transition: transform 0.2s; }
        .stat-card:active { transform: scale(0.98); }
        .stat-val { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: #888; }
        
        /* PROGRESS BAR */
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; margin: 10px 0; height: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--primary); width: 0%; transition: width 0.5s ease-in-out; }

        /* BLOOD SECTION */
        .blood-card { position: relative; }
        .blood-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 20px; font-size: 0.75rem; color: white; }
        .badge-Urgent { background: var(--danger); }
        .badge-Pending { background: #ff9800; color: white; }
        .badge-Completed { background: var(--primary); }
        .badge-Expired { background: #757575; color: white; }
        .blood-group { width: 50px; height: 50px; background: #ffebee; color: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; float: left; margin-right: 15px; }

        /* CHAT SYSTEM */
        #chat-container { height: calc(100vh - 140px); display: flex; flex-direction: column; position: relative; }
        #pinned-message-container { background: var(--surface-light); border-bottom: 1px solid rgba(0,0,0,0.1); padding: 8px 12px; font-size: 0.8rem; display: none; align-items: center; justify-content: space-between; color: var(--primary); cursor: pointer; }
        #messages-list { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; transition: background 0.3s; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 0.9rem; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.mine { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 0; color: #333; }
        .msg.others { background: white; align-self: flex-start; border-bottom-left-radius: 0; color: #333; }
        .msg.admin-msg { border: 2px solid var(--accent); }
        .msg-meta { font-size: 0.65rem; opacity: 0.7; text-align: right; margin-top: 4px; display: flex; justify-content: flex-end; gap: 10px; align-items: center;}
        .msg-action-btn { cursor: pointer; opacity: 0.6; transition: opacity 0.2s, transform 0.2s; }
        .msg-action-btn:hover { opacity: 1; transform: scale(1.1); }
        .msg-action-btn:active { transform: scale(0.95); }
        
        /* CHAT EXTRAS */
        .chat-input-area { display: flex; gap: 8px; flex-direction: column; }
        .input-row { display: flex; gap: 8px; }
        .reply-context { font-size: 0.75rem; background: rgba(0,0,0,0.05); padding: 4px 8px; border-left: 3px solid var(--primary); border-radius: 4px; margin-bottom: 4px; opacity: 0.8; }
        #reply-preview-bar { display: none; background: rgba(0,0,0,0.05); padding: 8px; border-left: 4px solid var(--accent); font-size: 0.8rem; justify-content: space-between; align-items: center; margin-bottom: 5px; border-radius: 8px; }

        /* NOTIFICATIONS */
        .notification-item { background: var(--surface-light); padding: 12px; border-radius: 12px; margin-bottom: 8px; border-left: 4px solid #ddd; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .notification-item.unread { border-left-color: var(--primary); background: rgba(27, 94, 32, 0.05); }
        .notif-content h5 { font-size: 0.9rem; margin-bottom: 2px; }
        .notif-content p { font-size: 0.75rem; color: #666; }

        /* TOGGLE SWITCH */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* SKELETON LOADER */
      /* SKELETON LOADER UPDATED */
        .skeleton { 
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%); 
            background-size: 200% 100%; 
            animation: shimmer 1.5s infinite; 
            border-radius: 8px; 
            color: transparent !important; /* ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            cursor: default;
        }
        .skeleton-text { height: 1em; margin-bottom: 5px; width: 80%; background-color: #eee; border-radius: 4px; }
        .skeleton-circle { width: 50px; height: 50px; border-radius: 50%; background-color: #eee; }
        .skeleton-box { height: 80px; width: 100%; border-radius: 12px; }
        
        @keyframes shimmer { 
            0% { background-position: -200% 0; } 
            100% { background-position: 200% 0; } 
        }
        /* ADMIN & MODALS */
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--surface-light); padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; color: var(--text-light); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        /* ONBOARDING */
        .onboarding-overlay { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000; background: rgba(0,0,0,0.8); display:flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px; text-align: center; }
        .onboarding-step { display: none; animation: fadeIn 0.5s; }
        .onboarding-step.active { display: block; }
        .onboarding-img { width: 80%; max-width: 200px; margin-bottom: 20px; }

        /* LOAD MORE */
        .load-more-btn { background: transparent; color: #888; border: 1px solid #ddd; margin: 10px auto; display: block; width: auto; }
        
        /* STATUS DOTS */
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background-color: var(--success); }

        /* USER MANAGEMENT STYLES */
        .user-mgmt-card { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px; 
            background: var(--surface-light); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            box-shadow: var(--shadow); 
            transition: transform 0.2s; 
        }
        .user-mgmt-card:hover { transform: translateX(5px); }
        .user-mgmt-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            object-fit: cover; 
            background: #e0e0e0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            color: #999; 
        }
        .user-mgmt-info { flex: 1; }
        .user-mgmt-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
        .user-mgmt-email { font-size: 0.75rem; opacity: 0.7; }
        .user-mgmt-meta { display: flex; gap: 8px; margin-top: 4px; flex-wrap: wrap; }
        .user-badge { 
            font-size: 0.7rem; 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-weight: 600; 
        }
        .badge-admin { background: var(--primary); color: white; }
        .badge-moderator { background: #ff9800; color: white; }
        .badge-member { background: #2196F3; color: white; }
        .badge-donor { background: #E91E63; color: white; }
        .badge-active { background: #4CAF50; color: white; }
        .badge-blocked { background: #f44336; color: white; }
        .user-mgmt-actions { display: flex; gap: 8px; }
        .action-icon-btn { 
            background: none; 
            border: none; 
            font-size: 1.1rem; 
            cursor: pointer; 
            padding: 6px 10px; 
            border-radius: 8px; 
            transition: all 0.2s; 
            width: auto; 
            margin: 0;
        }
        .action-icon-btn:hover { background: rgba(0,0,0,0.05); transform: scale(1.1); }
        .action-icon-btn:active { transform: scale(0.95); }
        .search-filter-bar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .search-filter-bar input, .search-filter-bar select { 
            flex: 1; 
            min-width: 150px; 
            margin: 0; 
        }
        html.dark-mode .user-mgmt-card { background: #242526; border: 1px solid rgba(255,255,255,0.05); }
        html.dark-mode .action-icon-btn:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <!-- LOADING OVERLAY -->
    <div id="global-loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--surface-light); z-index:999; display:flex; justify-content:center; align-items:center;">
        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal" class="onboarding-overlay hidden">
        <div class="onboarding-step active" id="step-1">
            <i class="fas fa-hand-holding-heart" style="font-size: 4rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h3>Welcome to Al Ikhlas</h3>
            <p>Manage donations, find blood donors, and connect with your community.</p>
            <button onclick="nextOnboarding(2)" style="margin-top: 20px; background: white; color: var(--primary);">Next</button>
        </div>
        <div class="onboarding-step" id="step-2">
            <i class="fas fa-tint" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
            <h3>Blood Bank</h3>
            <p>Request blood in emergencies or update your own eligibility status.</p>
            <button onclick="nextOnboarding(3)" style="margin-top: 20px; background: white; color: var(--primary);">Next</button>
        </div>
        <div class="onboarding-step" id="step-3">
            <i class="fas fa-comments" style="font-size: 4rem; color: #2196f3; margin-bottom: 20px;"></i>
            <h3>Stay Connected</h3>
            <p>Chat with members and get instant notifications on important updates.</p>
            <button onclick="finishOnboarding()" style="margin-top: 20px; background: white; color: var(--primary);">Get Started</button>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="hidden">
        <div class="auth-box">
            <h2 class="text-primary" style="margin-bottom:10px;">‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ</h2>
            <p style="margin-bottom:20px; font-size:0.9rem; color:#666;">Organization Management System v1.2</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email Address" required>
                <input type="password" id="login-pass" placeholder="Password" required>
                <button type="submit">Login</button>
                <p style="margin-top:15px; font-size:0.8rem; color:#666;">Don't have an account? <a href="#" onclick="toggleAuthMode('register')" class="text-primary">Register</a></p>
            </form>
            <form id="register-form" class="hidden">
                <div style="text-align:center; margin-bottom:10px;">
                    <i class="fas fa-camera text-primary" style="font-size:2rem; cursor:pointer;" onclick="document.getElementById('reg-img').click()"></i>
                    <p style="font-size:0.7rem; color:#666;">Upload Photo</p>
                    <input type="file" id="reg-img" accept="image/*" class="hidden" onchange="previewRegImage(this)">
                    <img id="reg-img-preview" src="" style="width:60px; height:60px; border-radius:50%; display:none; margin:0 auto;">
                </div>
                <input type="text" id="reg-name" placeholder="Full Name" required>
                <input type="email" id="reg-email" placeholder="Email Address" required>
                <input type="password" id="reg-pass" placeholder="Password" required>
                <input type="tel" id="reg-phone" placeholder="Phone Number" required>
                <input type="text" id="reg-address" placeholder="Address">
                <select id="reg-blood">
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option><option value="A-">A-</option>
                    <option value="B+">B+</option><option value="B-">B-</option>
                    <option value="O+">O+</option><option value="O-">O-</option>
                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                </select>
                <input type="text" id="reg-fb" placeholder="Facebook Profile Link (Optional)">
                <button type="submit">Create Account</button>
                <p style="margin-top:15px; font-size:0.8rem; color:#666;">Already have an account? <a href="#" onclick="toggleAuthMode('login')" class="text-primary">Login</a></p>
            </form>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="app-interface" class="hidden">
        
        <header>
            <h1><span data-i18n="app_title">‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ</span> <span id="user-role-badge" style="font-size:0.7rem; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">User</span></h1>
            <div style="position:relative;">
                <i class="fas fa-bell header-menu-btn" onclick="router('notifications', null)" style="margin-right: 10px;">
                    <span id="notif-badge" class="badge-count">0</span>
                </i>
                <i class="fas fa-ellipsis-v header-menu-btn" onclick="toggleMenu()"></i>
                <!-- HEADER MENU (UPDATED) -->
                <div id="header-dropdown" class="dropdown-menu">
                    <!-- Install App Link -->
                    <div class="dropdown-item" onclick="window.open('https://your-app-download-link.com', '_blank')">
                        <i class="fas fa-download"></i> <span data-i18n="menu_install">Install App</span>
                    </div>
                    <!-- Language Toggle -->
                    <div class="dropdown-item" onclick="toggleLanguage()">
                        <i class="fas fa-language"></i> <span id="lang-toggle-text">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
                    </div>
                    <div class="dropdown-item" onclick="openModal('modal-about')"><i class="fas fa-info-circle"></i> <span data-i18n="menu_about">About Org</span></div>
                    <div class="dropdown-item" onclick="toggleDarkMode()">
                        <i class="fas fa-moon"></i> <span data-i18n="menu_dark">Dark Mode</span>
                        <i id="dark-mode-status" class="fas fa-toggle-off text-primary" style="margin-left:auto;"></i>
                    </div>
                    <div class="dropdown-item" onclick="showOnboarding()"><i class="fas fa-question-circle"></i> <span data-i18n="menu_help">Help Guide</span></div>
                    <div class="dropdown-item text-red" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="menu_logout">Logout</span></div>
                    <div style="padding:10px; font-size:0.7rem; color:#888; text-align:center;">App Version: v1.2.0</div>
                </div>
            </div>
        </header>

        <!-- VIEW: HOME -->
        <div id="view-home" class="section">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-val" id="stat-funds">0‡ß≥</div>
                    <div class="stat-label" data-i18n="stat_collection">Total Collection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val text-red" id="stat-expense">0‡ß≥</div>
                    <div class="stat-label" data-i18n="stat_expense">Total Expense</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--primary);">
                    <div class="stat-val" id="stat-balance">0‡ß≥</div>
                    <div class="stat-label" data-i18n="stat_balance">Current Balance</div>
                </div>
                <div class="stat-card" onclick="router('members', null)" style="cursor:pointer; border-left-color: #888;">
                    <div class="stat-val" id="stat-members">0</div>
                    <div class="stat-label" data-i18n="stat_members">Members</div>
                </div>
            </div>

            <!-- Monthly Goal -->
            <div class="card" style="padding: 10px 15px;">
                <div class="flex justify-between" style="font-size: 0.8rem; margin-bottom: 5px;">
                    <span data-i18n="monthly_target">Monthly Target</span>
                    <span id="monthly-progress-text">0 / 0‡ß≥</span>
                </div>
                <div class="progress-container">
                    <div id="monthly-progress-bar" class="progress-bar"></div>
                </div>
                <small class="admin-only text-primary" onclick="openModal('modal-target')" style="cursor:pointer; font-size: 0.7rem;" data-i18n="edit_target">Edit Target</small>
            </div>

            <!-- Donation Card -->
            <div class="card" style="border-left: 4px solid green;">
                <div class="flex justify-between items-center">
                    <h4 data-i18n="btn_donate">ü§ù Donate Now</h4>
                    <i class="fas fa-edit admin-only text-primary" onclick="openModal('modal-donation-edit')" style="cursor:pointer;"></i>
                </div>
                <div class="donation-copy-box" style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border: 1px dashed var(--primary);">
                    <span>
                        <i class="fas fa-wallet text-primary"></i> 
                        <span id="display-donation-number">Loading...</span>
                    </span>
                    <i class="far fa-copy" onclick="copyDonation()" style="cursor:pointer; color:var(--primary);"></i>
                </div>
                <small style="opacity:0.7; display:block; margin-top:5px; text-align:center;">Send Money (bKash/Nagad)</small>
            </div>

            <h3 style="margin-bottom:10px;" data-i18n="header_notice">üìå Notice Board</h3>
            <div class="admin-only" style="margin-bottom:10px;">
                <button onclick="openModal('modal-notice')" class="secondary small-btn" data-i18n="btn_notice">+ Post Notice</button>
            </div>
            <div id="notice-list"></div>
            <button id="btn-load-more-notice" class="load-more-btn hidden" onclick="loadMoreNotices()" data-i18n="btn_load_more">Load More</button>
        </div>

        <!-- VIEW: BLOOD -->
        <div id="view-blood" class="section hidden">
            <h3 style="margin-bottom:10px;" data-i18n="header_blood">ü©∏ Blood Requests</h3>
            
            <div class="flex gap-2" style="margin-bottom: 15px;">
                <button onclick="openModal('modal-blood')" class="secondary w-full" data-i18n="btn_req_blood">+ Request Blood</button>
                <button onclick="filterBloodEligible()" id="btn-filter-eligible" class="secondary w-full" style="border-color:#ccc; color:#666;" data-i18n="btn_eligible_only">Eligible Only</button>
            </div>
            
            <div id="pending-blood-container" class="hidden">
                <h4 class="text-accent" style="margin:10px 0;">‚è≥ Pending Approval</h4>
                <div id="blood-pending-list"></div>
                <hr style="margin:20px 0; border:0; border-top:1px dashed #ccc;">
            </div>

            <h4 style="margin:10px 0;"><span data-i18n="header_active_req">Active Requests</span> <span id="active-blood-count" style="font-size:0.8rem; background:var(--primary); color:white; padding:2px 6px; border-radius:10px;">0</span></h4>
            <div id="blood-list"></div>
        </div>

        <!-- VIEW: MEMBERS DIRECTORY -->
        <div id="view-members" class="section hidden">
            <h3 data-i18n="header_members">üë• Member Directory</h3>
            <div class="flex gap-2" style="margin-bottom:15px;">
                <input type="text" id="member-search" placeholder="Search name..." onkeyup="filterMembers()" style="margin:0;">
                <select id="member-filter-blood" onchange="filterMembers()" style="width:100px; margin:0;">
                    <option value="All">All</option>
                    <option value="A+">A+</option><option value="A-">A-</option>
                    <option value="B+">B+</option><option value="B-">B-</option>
                    <option value="O+">O+</option><option value="O-">O-</option>
                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                </select>
            </div>
            <div id="members-list">
                <div class="spinner"></div>
            </div>
            <button id="btn-load-members" class="load-more-btn" onclick="loadMembers(true)" data-i18n="btn_load_more">Load More</button>
        </div>

        <!-- VIEW: CHAT -->
        <div id="view-chat" class="section hidden">
            <div id="chat-container">
                <div id="pinned-message-container" onclick="scrollToPinned()">
                    <div><i class="fas fa-thumbtack"></i> <span id="pinned-text-preview">Pinned Message</span></div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="messages-list"></div>
                <div class="chat-input-area">
                    <div id="reply-preview-bar">
                        <span>Replying to <b id="reply-to-name">Name</b></span>
                        <i class="fas fa-times" onclick="cancelReply()" style="cursor:pointer;"></i>
                    </div>
                    <div class="input-row">
                        <input type="text" id="chat-msg-input" placeholder="Type a message...">
                        <button onclick="sendChat()" style="width:auto;"><i class="fas fa-paper-plane"></i></button>
                        <button onclick="document.getElementById('chat-img-input').click()" style="width:auto; background:rgba(0,0,0,0.1); color:var(--text-light);"><i class="fas fa-image"></i></button>
                        <input type="file" id="chat-img-input" accept="image/*" class="hidden" onchange="handleChatImageUpload(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: NOTIFICATIONS -->
        <div id="view-notifications" class="section hidden">
            <h3 data-i18n="header_notif">üîî Notifications</h3>
            <div class="flex justify-between" style="margin-bottom: 10px;">
                <small>Stay updated</small>
                <small class="text-primary" onclick="markAllNotificationsRead()" style="cursor:pointer;">Mark all read</small>
            </div>
            <div id="notification-list">
                <p class="text-center" style="margin-top:20px; color:#888;">No notifications</p>
            </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="view-admin" class="section hidden">
            <h3 data-i18n="header_admin">üõ†Ô∏è Admin Panel</h3>
            <div class="stats-grid" style="margin-top:15px;">
                <button onclick="checkAdminAndOpen('modal-fund')" class="stat-card" style="border-left-color:green; cursor:pointer;">
                    <i class="fas fa-hand-holding-dollar text-primary" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;" data-i18n="btn_add_fund">Add Collection</div>
                </button>
                <button onclick="checkAdminAndOpen('modal-expense')" class="stat-card" style="border-left-color:red; cursor:pointer;">
                    <i class="fas fa-file-invoice-dollar text-red" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;" data-i18n="btn_add_expense">Add Expense</div>
                </button>
                <button onclick="checkAdminAndOpen('modal-admin-about')" class="stat-card" style="border-left-color:var(--primary); cursor:pointer;">
                    <i class="fas fa-circle-info text-primary" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;">Edit About</div>
                </button>
                <button onclick="checkAdminAndOpen('modal-add-donor')" class="stat-card" style="border-left-color:var(--danger); cursor:pointer;">
                    <i class="fas fa-droplet text-red" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;">Add Donor</div>
                </button>
                <button onclick="openUserManagement()" class="stat-card" style="border-left-color:#2196F3; cursor:pointer;">
                    <i class="fas fa-users-cog text-primary" style="font-size:1.5rem; color:#2196F3 !important;"></i>
                    <div class="stat-label" style="margin-top:5px;">User Management</div>
                </button>
            </div>
            
            <div class="card">
                <h4>Transaction History</h4>
                <div id="fund-history-list" style="max-height:200px; overflow-y:auto; font-size:0.85rem;"></div>
            </div>
        </div>

        <!-- VIEW: PROFILE -->
        <div id="view-profile" class="section hidden">
            <div class="card text-center">
                <img id="profile-img-display" src="" class="profile-img-lg hidden" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent); margin-bottom: 10px;">
                <div id="profile-initial-display" style="width:100px; height:100px; background:#ddd; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2rem; color:#888;">
                    <i class="fas fa-user"></i>
                </div>
                
                <h3 id="profile-name">Loading...</h3>
                <span id="profile-blood-badge" style="background:#ffebee; color:var(--danger); padding:2px 8px; border-radius:12px; font-weight:bold; font-size:0.9rem;"></span>
                
                <!-- Availability Status -->
                <div id="eligibility-container" style="margin: 10px 0;">
                    <span id="eligibility-badge" style="padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">Status Loading...</span>
                </div>

                <p id="profile-role" style="font-size:0.8rem; color:var(--primary); font-weight:600; margin-top:5px;"></p>
                <p id="profile-joined" style="font-size:0.75rem; opacity:0.6;">Joined: ...</p>
                
                <div style="margin: 15px 0; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px;">
                    <p id="profile-email" style="opacity:0.8; font-size:0.9rem; margin-bottom:5px;">...</p>
                    <p id="profile-address" style="opacity:0.8; font-size:0.9rem;">...</p>
                    
                    <div id="profile-contact-actions" style="margin-top:15px; display:flex; justify-content:center; gap:15px;">
                        <a id="link-call" href="#" class="hidden" style="color:var(--primary); font-size:1.5rem;"><i class="fas fa-phone-square-alt"></i></a>
                        <a id="link-fb" href="#" target="_blank" class="hidden" style="color:#1877F2; font-size:1.5rem;"><i class="fab fa-facebook-square"></i></a>
                    </div>
                </div>

                <button id="btn-edit-profile" class="secondary hidden" onclick="openModal('modal-edit-profile')" style="margin-top:10px;" data-i18n="btn_edit_profile">Edit Profile</button>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="router('home', this)">
                <i class="fas fa-home"></i> <span data-i18n="nav_home">Home</span>
            </div>
            <div class="nav-item" onclick="router('blood', this)">
                <div class="red-dot" id="blood-red-dot"></div>
                <i class="fas fa-tint"></i> <span data-i18n="nav_blood">Blood</span>
            </div>
            <div class="nav-item" onclick="router('chat', this)">
                <div class="badge-count" id="chat-unread-badge">0</div>
                <i class="fas fa-comments"></i> <span data-i18n="nav_chat">Chat</span>
            </div>
            <div class="nav-item admin-only" onclick="router('admin', this)">
                <i class="fas fa-shield-alt"></i> <span data-i18n="nav_admin">Admin</span>
            </div>
            <div class="nav-item" onclick="router('profile', this)">
                <i class="fas fa-user"></i> <span data-i18n="nav_profile">Profile</span>
            </div>
        </div>
    </div>

    <!-- VIEW: USER MANAGEMENT (Admin Only) -->
    <div id="view-user-management" class="section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3><i class="fas fa-users-cog text-primary"></i> User Management</h3>
            <button onclick="router('admin', document.querySelector('.nav-item.active'))" class="small-btn secondary">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>

        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
            <input type="text" id="user-search" placeholder="üîç Search users..." oninput="filterUsers()">
            <select id="role-filter" onchange="filterUsers()">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="moderator">Moderator</option>
                <option value="member">Member</option>
                <option value="donor">Donor</option>
            </select>
            <select id="status-filter" onchange="filterUsers()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="blocked">Blocked</option>
            </select>
        </div>

        <!-- User Stats Summary -->
        <div class="stats-grid" style="margin-bottom:15px;">
            <div class="stat-card">
                <div class="stat-val" id="total-users-count">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="active-users-count">0</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="blocked-users-count">0</div>
                <div class="stat-label">Blocked</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="admin-count">0</div>
                <div class="stat-label">Admins</div>
            </div>
        </div>

        <!-- Users List -->
        <div id="users-management-list"></div>
        
        <button id="btn-load-more-users" class="load-more-btn hidden" onclick="loadMoreUsers()">Load More Users</button>
    </div>

    <!-- MODALS -->
    <!-- About Modal -->
    <div id="modal-about" class="modal hidden">
        <div class="modal-content text-center">
            <h2 class="text-primary">‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ</h2>
            <p style="font-size:0.9rem; color:#666; margin:10px 0;">Al Ikhlas Organization</p>
            <hr style="border:0; border-top:1px solid rgba(0,0,0,0.1); margin:10px 0;">
            <p id="about-display-text" style="white-space: pre-wrap; text-align: left; font-size: 0.9rem;">Loading...</p>
            <div id="about-social-icons" style="margin-top:15px; font-size:1.5rem; display:flex; justify-content:center; gap:15px; color:var(--primary);"></div>
            <br>
            <button onclick="closeModal('modal-about')">Close</button>
        </div>
    </div>

    <!-- Admin: Edit About -->
    <div id="modal-admin-about" class="modal hidden">
        <div class="modal-content">
            <h3>Edit About Section</h3>
            <textarea id="admin-about-text" rows="6" placeholder="Write about org..."></textarea>
            <h4 style="margin-top:10px;">Social Links</h4>
            <input type="text" id="admin-fb-link" placeholder="Facebook URL">
            <input type="text" id="admin-yt-link" placeholder="YouTube URL">
            <input type="text" id="admin-web-link" placeholder="Website URL">
            <div class="flex gap-2">
                <button onclick="saveAboutSettings()">Save</button>
                <button class="secondary" onclick="closeModal('modal-admin-about')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin: Monthly Target -->
    <div id="modal-target" class="modal hidden">
        <div class="modal-content">
            <h3>Monthly Target</h3>
            <input type="number" id="admin-target-amount" placeholder="Target Amount (BDT)">
            <div class="flex gap-2">
                <button onclick="saveMonthlyTarget()">Save</button>
                <button class="secondary" onclick="closeModal('modal-target')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin: Add Donor -->
    <div id="modal-add-donor" class="modal hidden">
        <div class="modal-content">
            <h3>Add Manual Donor</h3>
            <input type="text" id="donor-name" placeholder="Name">
            <select id="donor-group">
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
            </select>
            <input type="text" id="donor-address" placeholder="Address">
            <input type="tel" id="donor-phone" placeholder="Phone">
            <div class="flex gap-2">
                <button onclick="saveDonor()">Save Donor</button>
                <button class="secondary" onclick="closeModal('modal-add-donor')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="modal-notice" class="modal hidden">
        <div class="modal-content">
            <h3>Post Notice</h3>
            <input type="text" id="notice-title" placeholder="Title">
            <textarea id="notice-content" rows="4" placeholder="Details..."></textarea>
            <input type="text" id="notice-yt" placeholder="YouTube Video URL (Optional)">
            <label style="font-size:0.8rem;">Attach Image (Optional):</label>
            <input type="file" id="notice-img" accept="image/*">
            <div class="flex gap-2">
                <button onclick="submitNotice()">Post</button>
                <button class="secondary" onclick="closeModal('modal-notice')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Blood Request Modal -->
    <div id="modal-blood" class="modal hidden">
        <div class="modal-content">
            <h3>Request Blood</h3>
            <p style="font-size:0.8rem; color:var(--danger); margin-bottom:10px;">* Requests need Admin approval.</p>
            <input type="text" id="blood-patient" placeholder="Patient Name">
            <select id="blood-group">
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
            </select>
            <input type="text" id="blood-hospital" placeholder="Hospital Name">
            <input type="tel" id="blood-contact" placeholder="Contact Number">
            <input type="text" id="blood-location" placeholder="Location">
            <div class="flex gap-2">
                <button onclick="submitBloodRequest()">Submit for Approval</button>
                <button class="secondary" onclick="closeModal('modal-blood')">Cancel</button>
            </div>
        </div>
    </div>
<!-- Fund Modal (Add Collection) -->
    <div id="modal-fund" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-green">Add Collection</h3>
            <input type="text" id="fund-name" placeholder="Member/Source Name">
            <input type="number" id="fund-amount" placeholder="Amount (BDT)">
            <div class="flex gap-2">
                <button onclick="submitFund('collection')">Save Collection</button>
                <button class="secondary" onclick="closeModal('modal-fund')">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Fund Modal -->
    <!-- Expense Modal (‡¶è‡¶á ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°‡ßá ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤) -->
    <div id="modal-expense" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-red">Add Expense</h3>
            <input type="text" id="expense-name" placeholder="Expense Reason/Name">
            <input type="number" id="expense-amount" placeholder="Amount (BDT)">
            <div class="flex gap-2">
                <!-- ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®: ‡¶è‡¶ñ‡¶æ‡¶®‡ßá submitFund('expense') ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                <button onclick="submitFund('expense')" class="danger">Save Expense</button>
                <button class="secondary" onclick="closeModal('modal-expense')">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Edit Transaction Modal (‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°‡ßá ‡¶®‡ßá‡¶á, ‡¶§‡¶æ‡¶á ‡¶è‡¶∞‡¶∞ ‡¶Ü‡¶∏‡¶õ‡ßá) -->
    <div id="modal-edit-transaction" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Transaction</h3>
            <!-- ‡¶è‡¶á ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶®‡¶æ ‡¶™‡ßá‡¶≤‡ßá setting 'value' ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡ßü -->
            <input type="hidden" id="edit-trans-id">
            <input type="text" id="edit-trans-name" placeholder="Name/Source">
            <input type="number" id="edit-trans-amount" placeholder="Amount (BDT)">
            
            <div class="flex gap-2">
                <button onclick="saveEditedTransaction()">Update</button>
                <button class="danger" onclick="deleteTransaction()">Delete</button>
            </div>
            <button class="secondary" onclick="closeModal('modal-edit-transaction')" style="margin-top:10px;">Cancel</button>
        </div>
    </div>
    <!-- Edit Profile Modal -->
    <div id="modal-edit-profile" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <label style="font-size:0.8rem;">Profile Picture</label>
            <input type="file" id="edit-profile-img" accept="image/*">
            <input type="text" id="edit-profile-name" placeholder="Full Name">
            <input type="text" id="edit-profile-address" placeholder="Address">
            <input type="tel" id="edit-profile-phone" placeholder="Phone">
            <input type="text" id="edit-profile-fb" placeholder="Facebook Link">
            
            <div style="margin: 15px 0; display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.05); padding:10px; border-radius:10px;">
                <span style="font-size:0.9rem;">Ready to Donate Blood?</span>
                <label class="switch">
                    <input type="checkbox" id="edit-blood-ready">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="flex gap-2">
                <button onclick="saveProfileChanges()">Update</button>
                <button class="secondary" onclick="closeModal('modal-edit-profile')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Donation Edit Modal -->
    <div id="modal-donation-edit" class="modal hidden">
        <div class="modal-content">
            <h3>Update Donation Info</h3>
            <input type="text" id="admin-donation-number" placeholder="bKash/Nagad Number">
            <div class="flex gap-2">
                <button onclick="saveDonationSettings()">Save</button>
                <button class="secondary" onclick="closeModal('modal-donation-edit')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- USER MANAGEMENT MODALS -->
    <!-- Edit User Role Modal -->
    <div id="modal-edit-user-role" class="modal hidden">
        <div class="modal-content">
            <h3>Change User Role</h3>
            <input type="hidden" id="edit-role-user-id">
            <p style="margin-bottom:10px; font-size:0.9rem;">
                User: <strong id="edit-role-user-name"></strong>
            </p>
            <select id="edit-role-select">
                <option value="member">Member</option>
                <option value="moderator">Moderator</option>
                <option value="admin">Admin</option>
                <option value="donor">Donor</option>
            </select>
            <div class="flex gap-2">
                <button onclick="saveUserRole()">Save Role</button>
                <button class="secondary" onclick="closeModal('modal-edit-user-role')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Block/Unblock User Modal -->
    <div id="modal-block-user" class="modal hidden">
        <div class="modal-content">
            <h3 id="block-modal-title">Block User</h3>
            <input type="hidden" id="block-user-id">
            <p style="margin-bottom:10px; font-size:0.9rem;">
                User: <strong id="block-user-name"></strong>
            </p>
            <p id="block-confirmation-text" style="font-size:0.85rem; opacity:0.8; margin-bottom:15px;"></p>
            <div class="flex gap-2">
                <button id="block-confirm-btn" class="danger" onclick="confirmBlockUser()">Block User</button>
                <button class="secondary" onclick="closeModal('modal-block-user')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="modal-delete-user" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-red">‚ö†Ô∏è Delete User Account</h3>
            <input type="hidden" id="delete-user-id">
            <p style="margin-bottom:10px; font-size:0.9rem;">
                User: <strong id="delete-user-name"></strong>
            </p>
            <p style="font-size:0.85rem; opacity:0.8; margin-bottom:10px; color:var(--danger);">
                This action cannot be undone! All user data will be permanently deleted.
            </p>
            <p style="font-size:0.8rem; margin-bottom:15px;">Type <strong>DELETE</strong> to confirm:</p>
            <input type="text" id="delete-confirmation-input" placeholder="Type DELETE">
            <div class="flex gap-2">
                <button class="danger" onclick="confirmDeleteUser()">Delete Permanently</button>
                <button class="secondary" onclick="closeModal('modal-delete-user')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="modal-user-details" class="modal hidden">
        <div class="modal-content">
            <h3>User Details</h3>
            <div id="user-details-content" style="font-size:0.9rem;">
                <!-- User details will be populated here -->
            </div>
            <button onclick="closeModal('modal-user-details')" style="margin-top:15px;">Close</button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" style="position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 200; width: 300px; text-align: center; pointer-events: none;"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, where, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update, get, query as rQuery, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG (Replace with your actual keys if needed, kept from original)
        const firebaseConfig = {
            apiKey: "AIzaSyAZ_pL1E_x7UyWoDDKg0mo6h15CZZhPQhA",
            authDomain: "al-ikhlas-3bae4.firebaseapp.com",
            databaseURL: "https://al-ikhlas-3bae4-default-rtdb.firebaseio.com",
            projectId: "al-ikhlas-3bae4",
            storageBucket: "al-ikhlas-3bae4.firebasestorage.app",
            messagingSenderId: "87930570775",
            appId: "1:87930570775:web:e25035f7549b1391153452"
        };
        const IMGBB_API_KEY = "6323eec33d6a157e5ef302037869d699"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        let currentUser = null;
        let userData = {};
        let isAdmin = false;
        let replyData = null;
        let lastMemberDoc = null; 
        let lastNoticeDoc = null;
        let pinnedMessageId = null;

        // --- CORE UTILS ---
        const SKELETON_CARD = '<div class="card skeleton" style="height:120px; margin-bottom:15px;"></div>';

        window.toggleMenu = () => { document.getElementById('header-dropdown').classList.toggle('show'); }
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header-menu-btn') && !e.target.closest('.dropdown-menu')) {
                document.getElementById('header-dropdown').classList.remove('show');
            }
        });

        // --- TRANSLATION SYSTEM ---
        const translations = {
            app_title: { en: "Al Ikhlas", bn: "‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ" },
            menu_install: { en: "Install App", bn: "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®" },
            menu_about: { en: "About Org", bn: "‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá" },
            menu_dark: { en: "Dark Mode", bn: "‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°" },
            menu_help: { en: "Help Guide", bn: "‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø" },
            menu_logout: { en: "Logout", bn: "‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü" },
            nav_home: { en: "Home", bn: "‡¶π‡ßã‡¶Æ" },
            nav_blood: { en: "Blood", bn: "‡¶∞‡¶ï‡ßç‡¶§" },
            nav_chat: { en: "Chat", bn: "‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü" },
            nav_admin: { en: "Admin", bn: "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®" },
            nav_profile: { en: "Profile", bn: "‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤" },
            stat_collection: { en: "Total Collection", bn: "‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π" },
            stat_expense: { en: "Total Expense", bn: "‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö" },
            stat_balance: { en: "Current Balance", bn: "‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ú‡ßá‡¶∞" },
            stat_members: { en: "Members", bn: "‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø" },
            monthly_target: { en: "Monthly Target", bn: "‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø" },
            edit_target: { en: "Edit Target", bn: "‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®" },
            btn_donate: { en: "ü§ù Donate Now", bn: "ü§ù ‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®" },
            header_notice: { en: "üìå Notice Board", bn: "üìå ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¨‡ßã‡¶∞‡ßç‡¶°" },
            btn_notice: { en: "+ Post Notice", bn: "+ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¶‡¶ø‡¶®" },
            btn_load_more: { en: "Load More", bn: "‡¶Ü‡¶∞‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" },
            header_blood: { en: "ü©∏ Blood Requests", bn: "ü©∏ ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß" },
            btn_req_blood: { en: "+ Request Blood", bn: "+ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®" },
            btn_eligible_only: { en: "Eligible Only", bn: "‡¶¶‡¶æ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ" },
            header_active_req: { en: "Active Requests", bn: "‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß" },
            header_members: { en: "üë• Member Directory", bn: "üë• ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ" },
            header_notif: { en: "üîî Notifications", bn: "üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®" },
            header_admin: { en: "üõ†Ô∏è Admin Panel", bn: "üõ†Ô∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤" },
            btn_add_fund: { en: "Add Collection", bn: "‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" },
            btn_add_expense: { en: "Add Expense", bn: "‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" },
            btn_edit_profile: { en: "Edit Profile", bn: "‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤" }
        };

        window.toggleLanguage = () => {
            const currentLang = localStorage.getItem('lang') || 'en';
            const newLang = currentLang === 'en' ? 'bn' : 'en';
            localStorage.setItem('lang', newLang);
            updateLanguage(newLang);
        };

        function updateLanguage(lang) {
            // Update text elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[key] && translations[key][lang]) {
                    el.textContent = translations[key][lang];
                }
            });

            // Update Toggle Button Text specifically
            const toggleText = document.getElementById('lang-toggle-text');
            if(toggleText) {
                toggleText.textContent = lang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
            }
        }

        // Initialize Language on Load
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('lang') || 'en';
            updateLanguage(savedLang);
        });


        window.toggleDarkMode = () => {
            const html = document.documentElement;
            html.classList.toggle('dark-mode');
            const isDark = html.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateDarkModeIcon(isDark);
        }

        function updateDarkModeIcon(isDark) {
            document.getElementById('dark-mode-status').className = isDark ? 'fas fa-toggle-on text-primary' : 'fas fa-toggle-off text-primary';
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
            updateDarkModeIcon(true);
        }

        window.showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.style.cssText = "background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 30px; margin-top: 10px; font-size: 0.9rem; backdrop-filter: blur(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s;";
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        window.toggleLoader = (show) => { document.getElementById('global-loader').style.display = show ? 'flex' : 'none'; }

        // IMAGE COMPRESSION
        async function compressImage(file) {
            if (!file.type.startsWith('image/')) return file;
            const bmp = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 800; 
            const scale = width / bmp.width;
            canvas.width = width;
            canvas.height = bmp.height * scale;
            ctx.drawImage(bmp, 0, 0, width, canvas.height);
            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.7)); 
        }

        async function uploadToImgBB(file) {
            const compressedFile = await compressImage(file);
            const formData = new FormData();
            formData.append("image", compressedFile);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const data = await res.json();
                return data.success ? data.data.url : null;
            } catch(e) { console.error(e); return null; }
        }

        // NAVIGATION
        window.router = (viewName, navEl, param = null) => {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            
            if(viewName === 'home') loadHomeData();
            if(viewName === 'blood') loadBloodRequests();
            if(viewName === 'members') loadMembers(); 
            if(viewName === 'chat') { 
                scrollToBottomChat(); 
                markChatRead(); 
            }
            if(viewName === 'admin') loadAdminData();
            if(viewName === 'profile') loadProfile(param);
            if(viewName === 'notifications') loadNotifications();
        }

        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('header-dropdown').classList.remove('show');
            if(id === 'modal-admin-about') populateAdminAbout();
        }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.checkAdminAndOpen = (modalId) => { if(isAdmin) openModal(modalId); else showToast("Access Denied"); }

        // --- AUTH & ONBOARDING ---
        window.toggleAuthMode = (mode) => {
            if(mode === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        }
        
        window.previewRegImage = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('reg-img-preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const phone = document.getElementById('reg-phone').value;
            const blood = document.getElementById('reg-blood').value;
            const address = document.getElementById('reg-address').value;
            const fb = document.getElementById('reg-fb').value;
            const fileInput = document.getElementById('reg-img');

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const photoURL = fileInput.files[0] ? await uploadToImgBB(fileInput.files[0]) : "";

                await setDoc(doc(db, "users", cred.user.uid), {
                    name, email, phone, bloodGroup: blood, address,
                    profileImage: photoURL || "",
                    socialLinks: { facebook: fb },
                    role: "member",
                    status: "active",
                    bloodEligible: true, // Default eligible
                    hasCompletedOnboarding: false,
                    createdAt: serverTimestamp()
                });

                await updateProfile(cred.user, { displayName: name, photoURL: photoURL });
                showToast("Account Created!");
                window.location.reload();
            } catch (error) { showToast("Error: " + error.message); toggleLoader(false); }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } 
            catch (error) { showToast("Login Failed: " + error.message); toggleLoader(false); }
        });

        // AUTH STATE CHANGE
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userSnap = await getDoc(doc(db, "users", user.uid));
                
                if (userSnap.exists()) {
                    userData = userSnap.data();
                    
                    // SECURITY: Check if user is blocked
                    if(userData.status === 'blocked') {
                        showToast("Your account has been blocked. Please contact admin.");
                        await signOut(auth);
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('app-interface').classList.add('hidden');
                        toggleLoader(false);
                        return;
                    }
                    
                    isAdmin = userData.role === 'admin';
                    document.body.classList.toggle('is-admin', isAdmin);
                    document.getElementById('user-role-badge').textContent = isAdmin ? 'Admin' : 'Member';
                    
                    // Onboarding Check
                    if (userData.hasCompletedOnboarding === false || userData.hasCompletedOnboarding === undefined) {
                        document.getElementById('onboarding-modal').classList.remove('hidden');
                    }
                    
                    // Start Heartbeat
                    startHeartbeat();
                    setupNotificationListener();
                    
                    // Ensure translation is applied after loading user-specific UI
                    setTimeout(() => updateLanguage(localStorage.getItem('lang') || 'en'), 500);
                }

                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                router('home', document.querySelector('.nav-item.active'));
                
                setupChatListener();
                setupBloodNotification();
                fetchDonationSettings();
                loadAboutData();
                fetchMonthlyTarget();

            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
            toggleLoader(false);
        });

        window.handleLogout = () => { signOut(auth); window.location.reload(); }

        // --- ONBOARDING ---
        window.nextOnboarding = (step) => {
            document.querySelectorAll('.onboarding-step').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
        }
        window.finishOnboarding = async () => {
            document.getElementById('onboarding-modal').classList.add('hidden');
            if (currentUser) {
                await updateDoc(doc(db, "users", currentUser.uid), { hasCompletedOnboarding: true });
            }
        }
        window.showOnboarding = () => {
             document.querySelectorAll('.onboarding-step').forEach(el => el.classList.remove('active'));
             document.getElementById('step-1').classList.add('active');
             document.getElementById('onboarding-modal').classList.remove('hidden');
             document.getElementById('header-dropdown').classList.remove('show');
        }

        // --- ONLINE STATUS (HEARTBEAT) ---
        function startHeartbeat() {
            setInterval(() => {
                if (currentUser) {
                    updateDoc(doc(db, "users", currentUser.uid), { lastActive: serverTimestamp() });
                }
            }, 60000); // Every 1 min
        }

        // --- HOME & DASHBOARD ---
        async function fetchMonthlyTarget() {
            const snap = await getDoc(doc(db, "settings", "donationTarget"));
            const target = snap.exists() ? (snap.data().monthlyTarget || 0) : 0;
            return target;
        }

        async function loadHomeData() {
            // ‡ßß. Skeleton ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã (‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá)
            const skeletonStats = '<div class="skeleton" style="height:20px; width:60px; margin:0 auto;"></div>';
            document.getElementById('stat-funds').innerHTML = skeletonStats;
            document.getElementById('stat-expense').innerHTML = skeletonStats;
            document.getElementById('stat-balance').innerHTML = skeletonStats;
            document.getElementById('stat-members').innerHTML = skeletonStats;

            // ‡ß®. ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡¶æ
            const fundSnap = await getDocs(collection(db, "funds"));
            let totalCol = 0, totalExp = 0, monthCol = 0;
            const currentMonth = new Date().getMonth();

            fundSnap.forEach(d => {
                const val = d.data();
                const amt = Number(val.amount);
                if(val.type === 'expense') totalExp += amt;
                else {
                    totalCol += amt;
                    if(val.timestamp && new Date(val.timestamp.toDate()).getMonth() === currentMonth) monthCol += amt;
                }
            });

            // ‡ß©. ‡¶Ü‡¶∏‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡¶∏‡¶æ‡¶®‡ßã
            document.getElementById('stat-funds').textContent = totalCol + "‡ß≥";
            document.getElementById('stat-expense').textContent = totalExp + "‡ß≥";
            document.getElementById('stat-balance').textContent = (totalCol - totalExp) + "‡ß≥";
            
            const userSnap = await getDocs(collection(db, "users")); 
            const donorSnap = await getDocs(query(collection(db, "donors"), where("status", "!=", "inactive"))); 
            document.getElementById('stat-members').textContent = userSnap.size + donorSnap.size;

            // Monthly Target
            const target = await fetchMonthlyTarget();
            document.getElementById('monthly-progress-text').textContent = `${monthCol} / ${target}‡ß≥`;
            const pct = target > 0 ? Math.min((monthCol / target) * 100, 100) : 0;
            document.getElementById('monthly-progress-bar').style.width = pct + "%";

            // Notices Update
            lastNoticeDoc = null;
            document.getElementById('notice-list').innerHTML = ''; 
            // Notice ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶õ‡ßã‡¶ü ‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡ßá‡¶ü‡¶®
            document.getElementById('notice-list').innerHTML = `
                <div class="card skeleton" style="height:100px;"></div>
                <div class="card skeleton" style="height:100px;"></div>
            `;
            loadMoreNotices();
        }
        window.loadMoreNotices = async () => {
            const btn = document.getElementById('btn-load-more-notice');
            const list = document.getElementById('notice-list');
            btn.textContent = "Loading...";
            
            let q = query(collection(db, "notices"), orderBy("timestamp", "desc"), limit(5));
            if (lastNoticeDoc) {
                q = query(collection(db, "notices"), orderBy("timestamp", "desc"), startAfter(lastNoticeDoc), limit(5));
            } else {
                // First load - clear skeleton loaders
                list.innerHTML = '';
            }

            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                btn.classList.add('hidden');
                if(!lastNoticeDoc) list.innerHTML = '<p style="text-align:center; opacity:0.6; padding:2rem;">No notices yet</p>';
                return;
            }

            lastNoticeDoc = snapshot.docs[snapshot.docs.length - 1];
            btn.textContent = "Load More";
            btn.classList.remove('hidden');

            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : '';
                
                let mediaHTML = '';
                if(data.youtubeUrl) {
                    // Enhanced YouTube ID extraction - handles all common formats
                    let vidId = null;
                    const url = data.youtubeUrl;
                    
                    // Check if URL contains 'v=' parameter (standard format)
                    if(url.includes('v=')) {
                        vidId = url.split('v=')[1].split('&')[0].split('?')[0];
                    }
                    // Check for youtu.be short links
                    else if(url.includes('youtu.be/')) {
                        vidId = url.split('youtu.be/')[1].split('?')[0].split('&')[0];
                    }
                    // Fallback: extract last part of URL
                    else {
                        vidId = url.split('/').pop().split('?')[0].split('&')[0];
                    }
                    
                    if(vidId) mediaHTML += `<div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 10px; background: #000; border-radius:12px;"><iframe src="https://www.youtube.com/embed/${vidId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;"></iframe></div>`;
                }
                if(data.imageUrl) {
                    mediaHTML += `<img src="${data.imageUrl}" loading="lazy" style="width:100%; border-radius:8px; margin-bottom:10px;">`;
                }

                const deleteBtn = isAdmin ? `<i class="fas fa-trash text-red" style="float:right; cursor:pointer;" onclick="deleteNotice('${doc.id}')"></i>` : '';

                const div = document.createElement('div');
                div.className = "card";
                div.innerHTML = `
                    <div class="flex justify-between items-center" style="margin-bottom:5px;">
                        <h4 style="color:var(--primary)">${data.title}</h4>
                        <small style="opacity:0.6">${date}</small>
                    </div>
                    ${mediaHTML}
                    <p style="font-size:0.9rem; opacity:0.8;">${data.content}</p>
                    ${deleteBtn}
                `;
                list.appendChild(div);
            });
        }

        window.saveMonthlyTarget = async () => {
            const amt = document.getElementById('admin-target-amount').value;
            await setDoc(doc(db, "settings", "donationTarget"), { monthlyTarget: Number(amt) });
            showToast("Target Updated");
            closeModal('modal-target');
            loadHomeData();
        }

        window.submitNotice = async () => {
            const title = document.getElementById('notice-title').value;
            const content = document.getElementById('notice-content').value;
            const yt = document.getElementById('notice-yt').value;
            const imgInput = document.getElementById('notice-img');
            
            if(!title || !content) return showToast("Required fields missing");

            toggleLoader(true);
            const imageUrl = imgInput.files[0] ? await uploadToImgBB(imgInput.files[0]) : null;

            await addDoc(collection(db, "notices"), { title, content, youtubeUrl: yt || null, imageUrl, timestamp: serverTimestamp(), author: currentUser.uid });
            showToast("Notice Posted!");
            closeModal('modal-notice');
            sendNotificationToAll("New Notice", title, "notice");
            loadHomeData();
            toggleLoader(false);
        }

        window.deleteNotice = async(id) => { if(confirm("Delete?")) { await deleteDoc(doc(db, "notices", id)); loadHomeData(); } }

        // --- BLOOD SYSTEM ---
        function setupBloodNotification() {
            onSnapshot(query(collection(db, "bloodRequests"), where("approved", "==", false)), (snap) => {
                document.getElementById('blood-red-dot').className = snap.size > 0 ? 'red-dot visible' : 'red-dot';
            });
        }

        async function loadBloodRequests(filterEligible = false) {
            const list = document.getElementById('blood-list');
            list.innerHTML = '';
            document.getElementById('blood-pending-list').innerHTML = '';
            
            let activeCount = 0;
            const q = query(collection(db, "bloodRequests"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            const now = Date.now();
            let hasPending = false;

            snap.forEach(async (docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                
                // Expiry Check
                if (data.status !== 'Expired' && data.status !== 'Completed') {
                     if (now - (data.timestamp?.toMillis() || 0) > 72 * 60 * 60 * 1000) {
                         await updateDoc(doc(db, "bloodRequests", id), { status: 'Expired' });
                         data.status = 'Expired';
                     }
                }

                const isMine = data.createdBy === currentUser.uid;
                if (!isAdmin && !isMine && (data.status === 'Expired' || data.status === 'Completed')) return;

                if (data.approved) {
                    if (data.status !== 'Expired' && data.status !== 'Completed') activeCount++;
                    renderBloodCard(id, data, list, false);
                } else if (isAdmin || isMine) {
                    hasPending = true;
                    renderBloodCard(id, data, document.getElementById('blood-pending-list'), true);
                }
            });
            
            document.getElementById('active-blood-count').textContent = activeCount;
            document.getElementById('pending-blood-container').classList.toggle('hidden', !hasPending);
        }

        function renderBloodCard(id, data, container, isPending) {
            const div = document.createElement('div');
            div.className = "card blood-card";
            div.innerHTML = `
                <span class="blood-badge badge-${data.status}">${data.status}</span>
                <div class="blood-group">${data.bloodGroup}</div>
                <div style="overflow:hidden;">
                    <h4>${data.hospital}</h4>
                    <p style="font-size:0.85rem; opacity:0.7;">Pt: ${data.patient}</p>
                    <p style="font-size:0.85rem;"><i class="fas fa-map-marker-alt"></i> ${data.location}</p>
                    ${!isPending && data.status === 'Urgent' ? `<a href="tel:${data.contact}" style="display:inline-block; margin-top:10px; font-weight:600; color:var(--primary); text-decoration:none;"><i class="fas fa-phone"></i> Call</a>` : ''}
                    <div style="margin-top:10px; border-top:1px solid rgba(0,0,0,0.1); padding-top:5px; text-align:right;">
                        ${(isAdmin && isPending) ? `<button onclick="updateBloodStatus('${id}', 'approve')" style="font-size:0.7rem; width:auto; background:green;">Approve</button> <button onclick="updateBloodStatus('${id}', 'reject')" style="font-size:0.7rem; width:auto; background:red;">Reject</button>` : ''}
                        ${(data.createdBy === currentUser.uid || isAdmin) && data.status === 'Urgent' ? `<button onclick="updateBloodStatus('${id}', 'complete')" style="font-size:0.7rem; width:auto;">Mark Done</button>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        window.submitBloodRequest = async () => {
            const data = {
                patient: document.getElementById('blood-patient').value,
                bloodGroup: document.getElementById('blood-group').value,
                hospital: document.getElementById('blood-hospital').value,
                contact: document.getElementById('blood-contact').value,
                location: document.getElementById('blood-location').value,
                status: 'Pending', approved: false, createdBy: currentUser.uid, timestamp: serverTimestamp()
            };
            await addDoc(collection(db, "bloodRequests"), data);
            showToast("Request Submitted");
            closeModal('modal-blood');
            sendNotificationToAll("New Blood Request", `Blood Needed: ${data.bloodGroup}`, "blood", true);
            loadBloodRequests();
        }

        window.updateBloodStatus = async (id, action) => {
            const ref = doc(db, "bloodRequests", id);
            if(action === 'approve') await updateDoc(ref, { approved: true, status: 'Urgent', approvedBy: currentUser.uid });
            if(action === 'reject') await deleteDoc(ref);
            if(action === 'complete') await updateDoc(ref, { status: 'Completed' });
            loadBloodRequests();
        }

        window.filterBloodEligible = () => {
            // Feature stub: In a real advanced app, this would filter visible requests or match donors
            // Since requests are passive, we will just toast for now or filter the member list in context
            showToast("Showing requests matching eligible donors...");
            // Logic would go here to cross ref
        }

        // --- MEMBERS & PAGINATION ---
        async function loadMembers(isLoadMore = false) {
            const list = document.getElementById('members-list');
            
            // Skeleton ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã (‡¶Ø‡¶¶‡¶ø Load More ‡¶®‡¶æ ‡¶π‡ßü)
            if(!isLoadMore) {
                list.innerHTML = '';
                lastMemberDoc = null;
                // ‡ß©‡¶ü‡¶ø ‡¶´‡ßá‡¶á‡¶ï ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                for(let i=0; i<3; i++) {
                    list.innerHTML += `
                        <div class="card flex items-center gap-2">
                            <div class="skeleton skeleton-circle"></div>
                            <div style="flex:1;">
                                <div class="skeleton skeleton-text" style="width:60%"></div>
                                <div class="skeleton skeleton-text" style="width:40%"></div>
                            </div>
                        </div>
                    `;
                }
            }

            let q = query(collection(db, "users"), orderBy("name"), limit(10));
            if(lastMemberDoc) q = query(collection(db, "users"), orderBy("name"), startAfter(lastMemberDoc), limit(10));

            const snap = await getDocs(q);
            
            // Skeleton ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡ßá)
            if(!isLoadMore) list.innerHTML = ''; 

            if(snap.empty) {
                document.getElementById('btn-load-members').style.display = 'none';
                if(!isLoadMore) list.innerHTML = "<p class='text-center'>No members found.</p>";
                return;
            }
            
            lastMemberDoc = snap.docs[snap.docs.length - 1];
            document.getElementById('btn-load-members').style.display = 'block';

            snap.forEach(d => renderMemberCard(d.id, d.data(), list));
            
            // Also load donors manually if it's the first load
            if(!isLoadMore) {
                const dSnap = await getDocs(query(collection(db, "donors"), where("status", "!=", "inactive")));
                dSnap.forEach(d => renderMemberCard(d.id, {...d.data(), type: 'donor'}, list));
            }
        }

        function renderMemberCard(id, u, container) {
            const isOnline = u.lastActive && (Date.now() - u.lastActive.toMillis() < 5 * 60 * 1000);
            const statusDot = isOnline ? '<span class="status-dot online"></span>' : '<span class="status-dot"></span>';
            const eligibleBadge = u.bloodEligible ? '<i class="fas fa-check-circle text-green" title="Ready to Donate"></i>' : '';

            container.innerHTML += `
                <div class="card member-card" data-name="${u.name.toLowerCase()}" data-blood="${u.bloodGroup || ''}" onclick="router('profile', null, '${id}')" style="cursor:pointer; padding:10px;">
                    <div class="flex items-center gap-2">
                        <img src="${u.profileImage || 'https://via.placeholder.com/50'}" loading="lazy" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                        <div style="flex:1;">
                            <h4 style="margin:0; font-size:1rem;">${u.name} ${eligibleBadge}</h4>
                            <div style="font-size:0.75rem; color:#666;">
                                ${statusDot} ${u.bloodGroup || 'N/A'} ${u.type === 'donor' ? '(Donor)' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.filterMembers = () => {
            const term = document.getElementById('member-search').value.toLowerCase();
            const blood = document.getElementById('member-filter-blood').value;
            document.querySelectorAll('.member-card').forEach(el => {
                const name = el.getAttribute('data-name');
                const bGroup = el.getAttribute('data-blood');
                el.style.display = (name.includes(term) && (blood === 'All' || bGroup === blood)) ? 'block' : 'none';
            });
        }

        // --- PROFILE & ELIGIBILITY ---
        async function loadProfile(uid) {
            toggleLoader(true);
            const targetId = uid || currentUser.uid;
            let u, isOwn = (targetId === currentUser.uid);

            let docSnap = await getDoc(doc(db, "users", targetId));
            if(docSnap.exists()) u = docSnap.data();
            else {
                docSnap = await getDoc(doc(db, "donors", targetId));
                if(docSnap.exists()) u = docSnap.data();
            }

            if(u) {
                document.getElementById('profile-name').textContent = u.name;
                document.getElementById('profile-email').textContent = u.email || "Manual Donor";
                document.getElementById('profile-role').textContent = u.role ? u.role.toUpperCase() : "MEMBER";
                document.getElementById('profile-address').textContent = u.address || "";
                document.getElementById('profile-blood-badge').textContent = u.bloodGroup || "N/A";
                
                // Image
                if(u.profileImage) {
                    document.getElementById('profile-img-display').src = u.profileImage;
                    document.getElementById('profile-img-display').classList.remove('hidden');
                    document.getElementById('profile-initial-display').classList.add('hidden');
                } else {
                    document.getElementById('profile-img-display').classList.add('hidden');
                    document.getElementById('profile-initial-display').classList.remove('hidden');
                }

                // FIX: PROFILE JOIN DATE LOGIC
                const dateStr = u.createdAt?.toDate ? u.createdAt.toDate().toLocaleDateString() : 'N/A';
                document.getElementById('profile-joined').textContent = "Joined: " + dateStr;

                // Eligibility
                const eligBadge = document.getElementById('eligibility-badge');
                if(u.bloodEligible) {
                    eligBadge.textContent = "Ready to Donate";
                    eligBadge.style.background = "#e8f5e9";
                    eligBadge.style.color = "#2e7d32";
                } else {
                    eligBadge.textContent = "Not Available";
                    eligBadge.style.background = "#ffebee";
                    eligBadge.style.color = "#c62828";
                }

                // Edit Button
                const btnEdit = document.getElementById('btn-edit-profile');
                if(isOwn) {
                    btnEdit.classList.remove('hidden');
                    // Set Toggle State
                    document.getElementById('edit-blood-ready').checked = u.bloodEligible;
                } else btnEdit.classList.add('hidden');

                // Links
                const linkCall = document.getElementById('link-call');
                if(u.phone) { linkCall.href = `tel:${u.phone}`; linkCall.classList.remove('hidden'); }
                const linkFb = document.getElementById('link-fb');
                if(u.socialLinks?.facebook) { linkFb.href = u.socialLinks.facebook; linkFb.classList.remove('hidden'); }
            }
            toggleLoader(false);
        }

        window.saveProfileChanges = async () => {
            toggleLoader(true);
            
            // 1. ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶®‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü Safety Check ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã (|| "")
            // ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡ßá ‡¶è‡¶¨‡¶Ç userData ‡¶§‡ßá‡¶ì ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá "" ‡¶¨‡¶∏‡¶¨‡ßá (undefined ‡¶π‡¶¨‡ßá ‡¶®‡¶æ)
            const name = document.getElementById('edit-profile-name').value || userData.name || "";
            const phone = document.getElementById('edit-profile-phone').value || userData.phone || "";
            const addr = document.getElementById('edit-profile-address').value || userData.address || "";
            
            // ‡¶∏‡ßã‡¶∂‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶∏‡ßá‡¶´‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï
            const fbInput = document.getElementById('edit-profile-fb').value;
            const oldFb = (userData.socialLinks && userData.socialLinks.facebook) ? userData.socialLinks.facebook : "";
            const fb = fbInput || oldFb || "";

            const eligible = document.getElementById('edit-blood-ready').checked;
            const file = document.getElementById('edit-profile-img').files[0];
            
            let url = userData.profileImage || "";
            
            try {
                if(file) url = await uploadToImgBB(file);

                await updateDoc(doc(db, "users", currentUser.uid), {
                    name: name, 
                    phone: phone, 
                    address: addr, 
                    profileImage: url,
                    socialLinks: { facebook: fb },
                    bloodEligible: eligible
                });
                
                showToast("Profile Updated Successfully!");
                loadProfile(currentUser.uid); // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
                closeModal('modal-edit-profile');
            } catch (error) {
                console.error("Update Error:", error);
                showToast("Error: " + error.message);
            }
            
            toggleLoader(false);
        }

        // --- CHAT SYSTEM (Pinned & Unread) ---
        function setupChatListener() {
            const chatRef = ref(rtdb, 'messages');
            
            // Pinned Logic: We check messages for isPinned
            // For simplicity in this structure, we scan incoming messages
            // Ideally, a separate node 'pinned_message' is better, but preserving structure:
            
            onChildAdded(chatRef, (snapshot) => {
                const msg = snapshot.val();
                if (msg.isPinned) updatePinnedUI(msg, snapshot.key);
                renderMessage(snapshot.key, msg);
                scrollToBottomChat();
                updateUnreadBadge(msg.timestamp);
            });
            
            onChildChanged(chatRef, (snapshot) => {
                 const msg = snapshot.val();
                 if (msg.isPinned) updatePinnedUI(msg, snapshot.key);
                 // If unpinned
                 if (!msg.isPinned && pinnedMessageId === snapshot.key) {
                     document.getElementById('pinned-message-container').style.display = 'none';
                     pinnedMessageId = null;
                 }
            });
            
            // NEW: Handle message deletion in real-time
            onChildRemoved(chatRef, (snapshot) => {
                const msgEl = document.getElementById(`msg-${snapshot.key}`);
                if(msgEl) {
                    msgEl.style.transition = 'opacity 0.3s';
                    msgEl.style.opacity = '0';
                    setTimeout(() => msgEl.remove(), 300);
                }
            });
        }

        function updatePinnedUI(msg, key) {
            pinnedMessageId = key;
            const con = document.getElementById('pinned-message-container');
            const txt = document.getElementById('pinned-text-preview');
            con.style.display = 'flex';
            txt.textContent = msg.type === 'image' ? 'Pinned Image' : msg.text;
        }

        window.scrollToPinned = () => {
            if(pinnedMessageId) document.getElementById(`msg-${pinnedMessageId}`).scrollIntoView({behavior: "smooth"});
        }

        function updateUnreadBadge(msgTime) {
            if(document.getElementById('view-chat').classList.contains('hidden')) {
                const lastSeen = localStorage.getItem('lastSeenChat') || 0;
                if(msgTime > lastSeen) {
                    const badge = document.getElementById('chat-unread-badge');
                    badge.textContent = Number(badge.textContent) + 1;
                    badge.style.display = 'block';
                }
            }
        }
        
        function markChatRead() {
            localStorage.setItem('lastSeenChat', Date.now());
            const badge = document.getElementById('chat-unread-badge');
            badge.textContent = '0';
            badge.style.display = 'none';
        }

        function createMessageHTML(key, msg) {
            const isMe = msg.uid === currentUser.uid;
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            return `
                <div id="msg-${key}" class="msg ${isMe ? 'mine' : 'others'} ${msg.isAdmin ? 'admin-msg' : ''}">
                    ${msg.isAdmin ? '<small class="text-primary font-bold">Admin</small>' : `<small class="text-primary font-bold">${msg.name}</small>`}
                    ${msg.replyTo ? `<div class="reply-context"><b>${msg.replyTo.name}</b>: ${msg.replyTo.text.substring(0,30)}...</div>` : ''}
                    ${msg.type === 'image' ? `<img src="${msg.text}" style="max-width:100%; border-radius:8px;">` : `<span>${msg.text}</span>`}
                    <div class="msg-meta">
                        <i class="fas fa-reply msg-action-btn" onclick="setReply('${key}', '${msg.name}', '${msg.type === 'image' ? 'Image' : msg.text.replace(/'/g, "\\'")}')"></i>
                        ${isMe ? `<i class="fas fa-trash msg-action-btn" onclick="deleteMessage('${key}')"></i>` : ''}
                        ${isAdmin ? `<i class="fas fa-thumbtack msg-action-btn" onclick="pinMessage('${key}')"></i>` : ''}
                        <span>${time}</span>
                    </div>
                </div>
            `;
        }

        function renderMessage(key, msg) {
            document.getElementById('messages-list').insertAdjacentHTML('beforeend', createMessageHTML(key, msg));
        }

        function scrollToBottomChat() {
            const list = document.getElementById('messages-list');
            list.scrollTop = list.scrollHeight;
        }

        window.sendChat = async () => {
            const input = document.getElementById('chat-msg-input');
            const text = input.value;
            if(!text) return;
            const msgData = { text, type: 'text', uid: currentUser.uid, name: userData.name || "User", isAdmin, timestamp: Date.now() };
            if(replyData) msgData.replyTo = replyData;
            await push(ref(rtdb, 'messages'), msgData);
            input.value = '';
            cancelReply();
        }

        window.pinMessage = async (key) => {
            if(!confirm("Pin this message?")) return;
            // Unpin others (basic implementation)
            // Just set this one true for now. In robust apps, reset others.
            await update(ref(rtdb, `messages/${key}`), { isPinned: true });
        }

        // NEW: Reply System Functions
        window.setReply = (msgKey, name, text) => {
            replyData = { msgKey, name, text };
            document.getElementById('reply-to-name').textContent = name;
            document.getElementById('reply-preview-bar').style.display = 'flex';
            document.getElementById('chat-msg-input').focus();
        }

        window.cancelReply = () => {
            replyData = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }

        // NEW: Delete Message Function
        window.deleteMessage = async (key) => {
            if(!confirm("Delete this message?")) return;
            try {
                await remove(ref(rtdb, `messages/${key}`));
                const msgEl = document.getElementById(`msg-${key}`);
                if(msgEl) msgEl.remove();
                showToast("Message deleted");
            } catch(e) {
                showToast("Error deleting message");
                console.error(e);
            }
        }

        // --- NOTIFICATIONS ---
        async function sendNotificationToAll(title, message, type, adminOnly = false) {
             // In a real backend (Cloud Functions) this loops users.
             // Here, client-side, we can't write to 100 docs efficiently.
             // Strategy: Add to a 'global_notifications' collection that client listens to.
             await addDoc(collection(db, "notifications"), {
                 title, message, type, timestamp: serverTimestamp(), target: adminOnly ? 'admin' : 'all'
             });
        }

        function setupNotificationListener() {
            const q = query(collection(db, "notifications"), orderBy("timestamp", "desc"), limit(10));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('notification-list');
                list.innerHTML = '';
                let count = 0;
                
                snap.forEach(d => {
                    const data = d.data();
                    if(data.target === 'admin' && !isAdmin) return;
                    
                    // Simple local read check (Using localStorage for simplicity)
                    const isRead = localStorage.getItem(`notif_read_${d.id}`);
                    if(!isRead) count++;

                    const div = document.createElement('div');
                    div.className = `notification-item ${!isRead ? 'unread' : ''}`;
                    div.innerHTML = `
                        <div class="notif-content" onclick="markRead('${d.id}')">
                            <h5>${data.title}</h5>
                            <p>${data.message}</p>
                        </div>
                    `;
                    list.appendChild(div);
                });
                
                const badge = document.getElementById('notif-badge');
                badge.textContent = count;
                badge.style.display = count > 0 ? 'block' : 'none';
            });
        }

        window.markRead = (id) => {
            localStorage.setItem(`notif_read_${id}`, 'true');
            // Trigger listener update without calling router to avoid recursion
            setupNotificationListener();
        }
        
        window.loadNotifications = () => {
             // Refresh notification view without calling router (to prevent recursion)
             // The notification listener already handles UI updates
             setupNotificationListener();
        }

        window.markAllNotificationsRead = () => {
            document.querySelectorAll('.notification-item').forEach(el => el.classList.remove('unread'));
            document.getElementById('notif-badge').style.display = 'none';
            showToast("All marked as read");
        }

        // --- ADMIN DONOR & SETTINGS ---
        window.saveDonor = async () => {
            const name = document.getElementById('donor-name').value;
            const group = document.getElementById('donor-group').value;
            const phone = document.getElementById('donor-phone').value;
            
            if(!name) return;
            await addDoc(collection(db, "donors"), { name, bloodGroup: group, phone, address: document.getElementById('donor-address').value, status: 'active', role: 'donor', createdAt: serverTimestamp() });
            showToast("Donor Added");
            closeModal('modal-add-donor');
        }

        // ABOUT & SOCIAL
        window.saveAboutSettings = async () => {
             await setDoc(doc(db, "settings", "about"), {
                 text: document.getElementById('admin-about-text').value,
                 social: { facebook: document.getElementById('admin-fb-link').value, youtube: document.getElementById('admin-yt-link').value, website: document.getElementById('admin-web-link').value }
             });
             showToast("Saved");
             closeModal('modal-admin-about');
             loadAboutData();
        }

        async function loadAboutData(){
            const snap = await getDoc(doc(db, "settings", "about"));
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('about-display-text').textContent = d.text;
                let html = '';
                if(d.social?.facebook) html += `<a href="${d.social.facebook}" target="_blank"><i class="fab fa-facebook"></i></a>`;
                if(d.social?.youtube) html += `<a href="${d.social.youtube}" target="_blank"><i class="fab fa-youtube"></i></a>`;
                document.getElementById('about-social-icons').innerHTML = html;
            }
        }
        
        async function populateAdminAbout(){
            const snap = await getDoc(doc(db, "settings", "about"));
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('admin-about-text').value = d.text || "";
                document.getElementById('admin-fb-link').value = d.social?.facebook || "";
                document.getElementById('admin-yt-link').value = d.social?.youtube || "";
                document.getElementById('admin-web-link').value = d.social?.website || "";
            }
        }

        // --- DONATION ---
        async function fetchDonationSettings() {
            const d = await getDoc(doc(db, "settings", "donation"));
            if(d.exists()) {
                document.getElementById('display-donation-number').textContent = d.data().number;
                if(document.getElementById('admin-donation-number')) document.getElementById('admin-donation-number').value = d.data().number;
            }
        }
        window.saveDonationSettings = async () => {
            await setDoc(doc(db, "settings", "donation"), { number: document.getElementById('admin-donation-number').value }, { merge: true });
            showToast("Saved");
            closeModal('modal-donation-edit');
            fetchDonationSettings();
        }
        window.copyDonation = () => { navigator.clipboard.writeText(document.getElementById('display-donation-number').textContent); showToast("Copied"); }

        // --- FUND ADMIN ---
        window.submitFund = async (type) => {
            const id = type === 'expense' ? 'expense' : 'fund';
            await addDoc(collection(db, "funds"), { 
                name: document.getElementById(`${id}-name`).value, 
                amount: Number(document.getElementById(`${id}-amount`).value), 
                type: type, 
                timestamp: serverTimestamp() 
            });
            showToast("Saved");
            closeModal(`modal-${id}`);
            loadAdminData();
            loadHomeData();
        }

        // --- UPDATED ADMIN FUNCTIONS ---

        async function loadAdminData() {
            const list = document.getElementById('fund-history-list');
            // Skeleton Loader for Admin List
            list.innerHTML = `
                <div class="skeleton skeleton-text w-full" style="height:30px; margin-bottom:10px;"></div>
                <div class="skeleton skeleton-text w-full" style="height:30px; margin-bottom:10px;"></div>
                <div class="skeleton skeleton-text w-full" style="height:30px; margin-bottom:10px;"></div>
            `;
            
            const snap = await getDocs(query(collection(db, "funds"), orderBy("timestamp", "desc"), limit(20)));
            list.innerHTML = ''; // Clear skeleton

            snap.forEach(docSnap => {
                 const d = docSnap.data();
                 const color = d.type === 'expense' ? 'red' : 'green';
                 const sign = d.type === 'expense' ? '-' : '+';
                 
                 // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶æ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá Edit ‡¶Ü‡¶á‡¶ï‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                 const div = document.createElement('div');
                 div.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;";
                 div.innerHTML = `
                    <div style="flex:1">
                        <span style="font-weight:600;">${d.name}</span>
                        <br><small style="opacity:0.6">${new Date(d.timestamp?.toDate()).toLocaleDateString()}</small>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:${color}; font-weight:bold;">${sign}${d.amount}</span>
                        <i class="fas fa-edit text-primary" style="cursor:pointer;" 
                           onclick="openEditTransaction('${docSnap.id}', '${d.name}', '${d.amount}', '${d.type}')"></i>
                    </div>
                 `;
                 list.appendChild(div);
            });
        }

        // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.openEditTransaction = (id, name, amount, type) => {
            document.getElementById('edit-trans-id').value = id;
            document.getElementById('edit-trans-name').value = name;
            document.getElementById('edit-trans-amount').value = amount;
            openModal('modal-edit-transaction');
        }

        // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.saveEditedTransaction = async () => {
            const id = document.getElementById('edit-trans-id').value;
            const name = document.getElementById('edit-trans-name').value;
            const amount = Number(document.getElementById('edit-trans-amount').value);

            if(!name || !amount) return showToast("All fields required");

            toggleLoader(true);
            try {
                await updateDoc(doc(db, "funds", id), {
                    name: name,
                    amount: amount
                });
                showToast("Transaction Updated");
                closeModal('modal-edit-transaction');
                loadAdminData(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
                loadHomeData();  // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
            } catch(e) {
                showToast("Error updating");
                console.error(e);
            }
            toggleLoader(false);
        }

        // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.deleteTransaction = async () => {
            const id = document.getElementById('edit-trans-id').value;
            if(!confirm("Are you sure you want to delete this record? This affects total balance.")) return;

            toggleLoader(true);
            try {
                await deleteDoc(doc(db, "funds", id));
                showToast("Record Deleted");
                closeModal('modal-edit-transaction');
                loadAdminData();
                loadHomeData();
            } catch(e) {
                showToast("Error deleting");
            }
            toggleLoader(false);
        }

        // ===== USER MANAGEMENT SYSTEM =====
        let allUsersData = [];
        let lastUserDoc = null;
        let usersLoaded = 0;

        // Open User Management View
        window.openUserManagement = () => {
            if(!isAdmin) {
                showToast("Access Denied");
                return;
            }
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-user-management').classList.remove('hidden');
            loadUsersList();
        }

        // Load Users List
        async function loadUsersList(loadMore = false) {
            const list = document.getElementById('users-management-list');
            
            if(!loadMore) {
                list.innerHTML = '<div class="skeleton" style="height:60px; margin-bottom:10px;"></div>'.repeat(3);
                lastUserDoc = null;
                usersLoaded = 0;
                allUsersData = [];
            }

            let q = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(20));
            if(lastUserDoc) {
                q = query(collection(db, "users"), orderBy("createdAt", "desc"), startAfter(lastUserDoc), limit(20));
            }

            const snap = await getDocs(q);
            
            if(!loadMore) list.innerHTML = '';

            if(snap.empty) {
                document.getElementById('btn-load-more-users').classList.add('hidden');
                if(!loadMore) list.innerHTML = '<p style="text-align:center; opacity:0.6; padding:2rem;">No users found</p>';
                return;
            }

            lastUserDoc = snap.docs[snap.docs.length - 1];
            
            snap.forEach(docSnap => {
                const userData = { id: docSnap.id, ...docSnap.data() };
                allUsersData.push(userData);
                renderUserCard(userData, list);
            });

            usersLoaded = allUsersData.length;
            document.getElementById('btn-load-more-users').classList.remove('hidden');
            
            updateUserStats();
        }

        window.loadMoreUsers = () => loadUsersList(true);

        // Render User Card
        function renderUserCard(user, container) {
            const role = user.role || 'member';
            const status = user.status === 'blocked' ? 'blocked' : 'active';
            const joinDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';
            
            const card = document.createElement('div');
            card.className = 'user-mgmt-card';
            card.setAttribute('data-user-id', user.id);
            card.setAttribute('data-role', role);
            card.setAttribute('data-status', status);
            card.setAttribute('data-search-text', `${user.name} ${user.email} ${user.bloodGroup || ''}`.toLowerCase());
            
            const avatar = user.profileImage 
                ? `<img src="${user.profileImage}" class="user-mgmt-avatar" alt="${user.name}">`
                : `<div class="user-mgmt-avatar"><i class="fas fa-user"></i></div>`;
            
            card.innerHTML = `
                ${avatar}
                <div class="user-mgmt-info">
                    <div class="user-mgmt-name">${user.name || 'No Name'}</div>
                    <div class="user-mgmt-email">${user.email}</div>
                    <div class="user-mgmt-meta">
                        <span class="user-badge badge-${role}">${role.toUpperCase()}</span>
                        <span class="user-badge badge-${status}">${status.toUpperCase()}</span>
                        ${user.bloodGroup ? `<span class="user-badge" style="background:#ffebee; color:#d32f2f;">${user.bloodGroup}</span>` : ''}
                        <span style="font-size:0.7rem; opacity:0.6;">Joined: ${joinDate}</span>
                    </div>
                </div>
                <div class="user-mgmt-actions">
                    <button class="action-icon-btn" onclick="openUserDetails('${user.id}')" title="View Details">
                        <i class="fas fa-eye text-primary"></i>
                    </button>
                    <button class="action-icon-btn" onclick="openEditRole('${user.id}', '${user.name}', '${role}')" title="Change Role">
                        <i class="fas fa-user-tag" style="color:#2196F3;"></i>
                    </button>
                    <button class="action-icon-btn" onclick="openBlockUser('${user.id}', '${user.name}', '${status}')" title="${status === 'blocked' ? 'Unblock' : 'Block'}">
                        <i class="fas fa-${status === 'blocked' ? 'unlock' : 'ban'}" style="color:${status === 'blocked' ? '#4CAF50' : '#ff9800'};"></i>
                    </button>
                    <button class="action-icon-btn" onclick="openDeleteUser('${user.id}', '${user.name}')" title="Delete User">
                        <i class="fas fa-trash text-red"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        }

        // Filter Users
        window.filterUsers = () => {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            const cards = document.querySelectorAll('.user-mgmt-card');
            
            cards.forEach(card => {
                const searchText = card.getAttribute('data-search-text');
                const cardRole = card.getAttribute('data-role');
                const cardStatus = card.getAttribute('data-status');
                
                const matchSearch = searchText.includes(searchTerm);
                const matchRole = !roleFilter || cardRole === roleFilter;
                const matchStatus = !statusFilter || cardStatus === statusFilter;
                
                if(matchSearch && matchRole && matchStatus) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Update User Stats
        function updateUserStats() {
            const total = allUsersData.length;
            const active = allUsersData.filter(u => u.status !== 'blocked').length;
            const blocked = allUsersData.filter(u => u.status === 'blocked').length;
            const admins = allUsersData.filter(u => u.role === 'admin').length;
            
            document.getElementById('total-users-count').textContent = total;
            document.getElementById('active-users-count').textContent = active;
            document.getElementById('blocked-users-count').textContent = blocked;
            document.getElementById('admin-count').textContent = admins;
        }

        // Edit Role Functions
        window.openEditRole = (userId, userName, currentRole) => {
            document.getElementById('edit-role-user-id').value = userId;
            document.getElementById('edit-role-user-name').textContent = userName;
            document.getElementById('edit-role-select').value = currentRole;
            openModal('modal-edit-user-role');
        }

        window.saveUserRole = async () => {
            const userId = document.getElementById('edit-role-user-id').value;
            const newRole = document.getElementById('edit-role-select').value;
            
            toggleLoader(true);
            try {
                await updateDoc(doc(db, "users", userId), { role: newRole });
                showToast("Role updated successfully");
                closeModal('modal-edit-user-role');
                
                // Update local data
                const userIndex = allUsersData.findIndex(u => u.id === userId);
                if(userIndex !== -1) {
                    allUsersData[userIndex].role = newRole;
                }
                
                // Refresh list
                const list = document.getElementById('users-management-list');
                list.innerHTML = '';
                allUsersData.forEach(u => renderUserCard(u, list));
                updateUserStats();
            } catch(e) {
                showToast("Error updating role");
                console.error(e);
            }
            toggleLoader(false);
        }

        // Block/Unblock Functions
        window.openBlockUser = (userId, userName, currentStatus) => {
            document.getElementById('block-user-id').value = userId;
            document.getElementById('block-user-name').textContent = userName;
            
            if(currentStatus === 'blocked') {
                document.getElementById('block-modal-title').textContent = 'Unblock User';
                document.getElementById('block-confirmation-text').textContent = 'This user will be able to log in and use the app again.';
                document.getElementById('block-confirm-btn').textContent = 'Unblock User';
                document.getElementById('block-confirm-btn').className = 'success';
            } else {
                document.getElementById('block-modal-title').textContent = 'Block User';
                document.getElementById('block-confirmation-text').textContent = 'This user will not be able to log in or access the app.';
                document.getElementById('block-confirm-btn').textContent = 'Block User';
                document.getElementById('block-confirm-btn').className = 'danger';
            }
            
            openModal('modal-block-user');
        }

        window.confirmBlockUser = async () => {
            const userId = document.getElementById('block-user-id').value;
            const userIndex = allUsersData.findIndex(u => u.id === userId);
            const currentStatus = userIndex !== -1 ? allUsersData[userIndex].status : 'active';
            const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
            
            toggleLoader(true);
            try {
                await updateDoc(doc(db, "users", userId), { status: newStatus });
                showToast(newStatus === 'blocked' ? "User blocked" : "User unblocked");
                closeModal('modal-block-user');
                
                // Update local data
                if(userIndex !== -1) {
                    allUsersData[userIndex].status = newStatus;
                }
                
                // Refresh list
                const list = document.getElementById('users-management-list');
                list.innerHTML = '';
                allUsersData.forEach(u => renderUserCard(u, list));
                updateUserStats();
            } catch(e) {
                showToast("Error updating user status");
                console.error(e);
            }
            toggleLoader(false);
        }

        // Delete User Functions
        window.openDeleteUser = (userId, userName) => {
            document.getElementById('delete-user-id').value = userId;
            document.getElementById('delete-user-name').textContent = userName;
            document.getElementById('delete-confirmation-input').value = '';
            openModal('modal-delete-user');
        }

        window.confirmDeleteUser = async () => {
            const confirmation = document.getElementById('delete-confirmation-input').value;
            if(confirmation !== 'DELETE') {
                showToast("Please type DELETE to confirm");
                return;
            }
            
            const userId = document.getElementById('delete-user-id').value;
            
            toggleLoader(true);
            try {
                // Delete user document
                await deleteDoc(doc(db, "users", userId));
                showToast("User deleted permanently");
                closeModal('modal-delete-user');
                
                // Remove from local data
                allUsersData = allUsersData.filter(u => u.id !== userId);
                
                // Refresh list
                const list = document.getElementById('users-management-list');
                list.innerHTML = '';
                allUsersData.forEach(u => renderUserCard(u, list));
                updateUserStats();
            } catch(e) {
                showToast("Error deleting user");
                console.error(e);
            }
            toggleLoader(false);
        }

        // View User Details
        window.openUserDetails = async (userId) => {
            toggleLoader(true);
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if(!userDoc.exists()) {
                    showToast("User not found");
                    toggleLoader(false);
                    return;
                }
                
                const user = userDoc.data();
                const joinDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';
                const lastActive = user.lastActive ? new Date(user.lastActive.toDate()).toLocaleString() : 'Never';
                
                const detailsHTML = `
                    <div style="text-align:center; margin-bottom:15px;">
                        ${user.profileImage ? `<img src="${user.profileImage}" style="width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:10px;">` : ''}
                        <h4>${user.name}</h4>
                        <span class="user-badge badge-${user.role || 'member'}">${(user.role || 'member').toUpperCase()}</span>
                    </div>
                    <div style="text-align:left; line-height:1.8;">
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                        <p><strong>Blood Group:</strong> ${user.bloodGroup || 'N/A'}</p>
                        <p><strong>Address:</strong> ${user.address || 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="user-badge badge-${user.status === 'blocked' ? 'blocked' : 'active'}">${(user.status === 'blocked' ? 'blocked' : 'active').toUpperCase()}</span></p>
                        <p><strong>Blood Eligible:</strong> ${user.bloodEligible ? '‚úÖ Yes' : '‚ùå No'}</p>
                        <p><strong>Joined:</strong> ${joinDate}</p>
                        <p><strong>Last Active:</strong> ${lastActive}</p>
                        ${user.socialLinks?.facebook ? `<p><strong>Facebook:</strong> <a href="${user.socialLinks.facebook}" target="_blank">View Profile</a></p>` : ''}
                    </div>
                `;
                
                document.getElementById('user-details-content').innerHTML = detailsHTML;
                openModal('modal-user-details');
            } catch(e) {
                showToast("Error loading user details");
                console.error(e);
            }
            toggleLoader(false);
        }
        // ===== END USER MANAGEMENT SYSTEM =====
    </script>
<script src="update-checker.js"></script>
</body>
</html>
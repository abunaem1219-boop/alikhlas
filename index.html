<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ | Al Ikhlas Organization</title>
    <!-- Google Fonts: Hind Siliguri for Bengali, Poppins for English -->
    <link href="https://fonts.googleapi.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Premium Gradient Theme */
            --primary-gradient: linear-gradient(135deg, #11998e, #38ef7d);
            --primary: #11998e;
            --primary-light: #38ef7d;
            
            --accent: #FFD700; /* Gold for accents */
            --danger: #ff4b4b;
            --success: #00b894;
            
            /* Glassmorphism Backgrounds */
            --bg-light: #f0f2f5;
            --bg-dark: #121212;
            
            --glass-surface: rgba(255, 255, 255, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --glass-blur: blur(12px);
            
            --text-light: #2d3436;
            --text-dark: #dfe6e9;
            
            /* Soft Shadow */
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); 
            --radius: 20px;

            /* Chat Specific Colors */
            --chat-bg: #e5ddd5;
            --chat-mine: #dcf8c6;
            --chat-others: #ffffff;
        }

        /* DARK MODE OVERRIDES */
        html.dark-mode {
            --bg-light: #0f0f10;  
            --glass-surface: rgba(30, 30, 30, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-light: #e4e6eb;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --chat-bg: #0b141a;
            --chat-mine: #005c4b;
            --chat-others: #202c33;
        }

        /* GLOBAL RESET & BASE */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Poppins', 'Hind Siliguri', sans-serif; 
            background-color: var(--bg-light); 
            background-image: radial-gradient(circle at 10% 20%, rgba(56, 239, 125, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(17, 153, 142, 0.05) 0%, transparent 20%);
            background-attachment: fixed;
            color: var(--text-light); 
            transition: background-color 0.3s, color 0.3s; 
            padding-bottom: 70px;
            overscroll-behavior-y: none; /* Reduced padding for compact nav */
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        body:not(.is-admin) .admin-only { display: none !important; } /* ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-primary { color: var(--primary); }
        .text-accent { color: var(--accent); }
        .text-red { color: var(--danger); }
        .text-green { color: var(--success); }

        /* GLASS CARD DESIGN */
        .card { 
            background: var(--glass-surface);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius); 
            padding: 1rem; 
            box-shadow: var(--shadow); 
            margin-bottom: 0.8rem; /* More compact */
            position: relative; 
            transition: transform 0.2s, box-shadow 0.3s; 
        }
        .card:active { transform: scale(0.98); }

        /* HEADER & MENU */
        header { 
            background: var(--primary-gradient); 
            color: white; 
            padding: 0.8rem 1rem; 
            position: sticky; top: 0; z-index: 50; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        header h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.5px; }

        .header-menu-btn { cursor: pointer; padding: 5px; font-size: 1.2rem; position: relative; }
        .dropdown-menu { position: absolute; top: 50px; right: 10px; background: var(--glass-surface); backdrop-filter: var(--glass-blur); color: var(--text-light); border-radius: 12px; box-shadow: var(--shadow); width: 200px; display: none; flex-direction: column; overflow: hidden; z-index: 1000; border: var(--glass-border); }
        .dropdown-menu.show { display: flex; animation: slideDown 0.2s ease; }
        .dropdown-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .dropdown-item:hover { background: rgba(0,0,0,0.05); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* AUTH SCREEN */
        #auth-screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; background: var(--primary-gradient); }
        .auth-box { background: white; padding: 2rem; border-radius: var(--radius); width: 100%; max-width: 400px; text-align: center; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        /* Auth Help Link */
        .auth-help-link {
            color: white;
            text-decoration: underline;
            font-size: 0.9rem;
            margin-bottom: 20px;
            opacity: 0.9;
            cursor: pointer;
            font-weight: 500;
        }

        /* FORM ELEMENTS */
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-family: inherit; background: rgba(255,255,255,0.5); color: var(--text-light); transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(56, 239, 125, 0.2); background: #fff; }
        html.dark-mode input, html.dark-mode select, html.dark-mode textarea { background: rgba(0,0,0,0.3); color: white; border-color: rgba(255,255,255,0.1); }

        button { background: var(--primary-gradient); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.97); }
        button.secondary { background: transparent; border: 1px solid var(--primary); color: var(--primary); box-shadow: none; }
        button.danger { background: var(--danger); color: white; border: none; }
        button.small-btn { width: auto; padding: 6px 12px; font-size: 0.8rem; }

        /* NAVIGATION (Compact) */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--glass-surface); 
            backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; 
            padding: 8px 0; /* Reduced padding */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); 
            z-index: 100; border-top: var(--glass-border); 
            border-radius: 20px 20px 0 0; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #999; cursor: pointer; position: relative; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: 600; transform: translateY(-2px); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }

        /* BADGES */
        .red-dot { position: absolute; top: -2px; right: 5px; width: 8px; height: 8px; background: red; border-radius: 50%; border: 1px solid white; display: none; }
        .red-dot.visible { display: block; }
        .badge-count { position: absolute; top: -5px; right: 0px; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 10px; display: none; }

        /* DASHBOARD GRID (Compact) */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; margin-bottom: 0.8rem; }
        .stat-card { 
            background: var(--glass-surface); padding: 0.8rem; border-radius: var(--radius); 
            text-align: center; border: var(--glass-border);
            border-left: 3px solid var(--accent); transition: transform 0.2s; 
        }
        .stat-val { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: #888; }

        /* CIRCULAR PROGRESS BAR */
        .circular-progress {
            position: relative;
            width: 70px;
            height: 70px;
            margin: 0 auto;
        }
        .circular-progress svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .circular-progress circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }
        .progress-bg { stroke: rgba(0,0,0,0.05); }
        .progress-val { stroke: var(--primary); transition: stroke-dashoffset 1s ease; }
        .progress-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.75rem; font-weight: bold; color: var(--text-light);
        }

        /* NOTICE CAROUSEL (Swipeable) */
        #notice-list {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 10px;
            padding-bottom: 10px;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #notice-list::-webkit-scrollbar { display: none; }
        .notice-card {
            flex: 0 0 85%; /* Shows part of next card */
            scroll-snap-align: center;
            min-height: 120px;
            display: flex; flex-direction: column;
            max-height: 300px;
            overflow-y: auto; /* Internal scroll for long text */
        }

        /* BLOOD SECTION */
        .blood-card { position: relative; overflow: hidden; }
        .blood-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge-Urgent { background: var(--danger); animation: pulse 1.5s infinite; }
        .badge-Pending { background: #ff9800; color: white; animation: pulse 2s infinite; }
        .badge-Completed { background: var(--success); }
        .badge-Expired { background: #757575; color: white; }

        /* Droplet Shape */
        .blood-group { 
            width: 45px; height: 45px; 
            background: linear-gradient(135deg, #ff4b4b, #d32f2f); 
            color: white; 
            border-radius: 0 50% 50% 50%; /* Droplet */
            transform: rotate(45deg);
            display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: 1rem; 
            float: left; margin-right: 15px; margin-top: 5px; margin-left: 5px;
            box-shadow: 2px 2px 5px rgba(211, 47, 47, 0.4);
        }
        .blood-group span { transform: rotate(-45deg); } /* Fix text rotation */

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(255, 75, 75, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 75, 75, 0); }
        }

        /* --- PREMIUM CHAT SYSTEM STYLES --- */
        /* INBOX LIST */
        #chat-inbox-list { padding-bottom: 20px; }
        .chat-list-item {
            display: flex; align-items: center; padding: 12px 10px;
            background: var(--glass-surface); border-radius: 12px;
            margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
            border: var(--glass-border);
        }
        .chat-list-item:hover { background: rgba(0,0,0,0.05); }
        .chat-avatar-container { position: relative; margin-right: 12px; }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .status-indicator {
            position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px;
            border-radius: 50%; border: 2px solid white; background: #ccc;
        }
        .status-online { background: #00b894; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: 600; font-size: 0.95rem; display: block; }
        .chat-preview { font-size: 0.8rem; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { font-size: 0.7rem; color: #999; margin-left: 8px; }

        /* CHAT ROOM */
        #chat-room-view { display: flex; flex-direction: column; height: calc(100vh - 130px); background: var(--chat-bg); position: relative; }
        .chat-pattern {
            position: absolute; width:100%; height:100%; top:0; left:0; opacity: 0.06; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23000000' fill-opacity='1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .chat-room-header {
            background: var(--glass-surface); padding: 10px; display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10;
        }
        .chat-back-btn { font-size: 1.2rem; padding: 5px 10px; cursor: pointer; color: var(--primary); }
        .room-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .room-info h4 { margin: 0; font-size: 0.95rem; line-height: 1.1; }
        .room-info p { margin: 0; font-size: 0.7rem; color: #888; }
        
        #messages-container { flex: 1; overflow-y: auto; padding: 15px; z-index: 5; display: flex; flex-direction: column; gap: 4px; }
        
        /* BUBBLES */
        .msg-bubble {
            max-width: 75%; padding: 8px 12px; font-size: 0.9rem; border-radius: 8px; position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; margin-bottom: 4px;
        }
        .msg-bubble.mine {
            background: var(--chat-mine); align-self: flex-end; color: var(--text-light);
            border-top-right-radius: 0;
        }
        .msg-bubble.others {
            background: var(--chat-others); align-self: flex-start; color: var(--text-light);
            border-top-left-radius: 0; margin-left: 35px; /* space for avatar */
        }
        html.dark-mode .msg-bubble.mine { color: #fff; }
        html.dark-mode .msg-bubble.others { color: #fff; }
        
        /* Message Avatar for others */
        .msg-avatar-small {
            position: absolute; left: -35px; top: 0; width: 28px; height: 28px; 
            border-radius: 50%; object-fit: cover; cursor: pointer; border: 1px solid rgba(0,0,0,0.1);
        }

        /* Tails */
        .msg-bubble.mine::after {
            content: ""; position: absolute; top: 0; right: -8px; width: 0; height: 0;
            border-top: 10px solid var(--chat-mine); border-right: 10px solid transparent;
        }
        .msg-bubble.others::after {
            content: ""; position: absolute; top: 0; left: -8px; width: 0; height: 0;
            border-top: 10px solid var(--chat-others); border-left: 10px solid transparent;
        }

        .msg-meta { display: flex; justify-content: flex-end; align-items: center; font-size: 0.65rem; margin-top: 3px; opacity: 0.6; gap: 5px; }
        .msg-name { font-weight: bold; font-size: 0.75rem; color: var(--primary); margin-bottom: 2px; display: block; }
        .msg-reply-bar { font-size:0.75rem; background:rgba(0,0,0,0.05); padding:4px; border-left:3px solid var(--primary); margin-bottom:4px; border-radius: 4px; }
        
        .chat-input-area { 
            padding: 8px; background: var(--glass-surface); border-top: var(--glass-border); 
            display: flex; gap: 8px; align-items: center; z-index: 10;
        }
        
        /* TYPING INDICATOR */
        .typing-indicator {
            background: var(--chat-others); padding: 8px 15px; border-radius: 20px;
            display: inline-flex; align-items: center; gap: 4px; margin-left: 35px; margin-bottom: 10px; width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .typing-dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- END CHAT STYLES --- */

        /* FLOATING ACTION BUTTON (FAB) */
        .fab-container { position: fixed; bottom: 80px; right: 20px; z-index: 90; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
        .fab-main {
            width: 55px; height: 55px; border-radius: 50%;
            background: var(--primary-gradient); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(0,255,100,0.3);
            cursor: pointer; transition: transform 0.3s;
        }
        .fab-main:active { transform: scale(0.9); }
        .fab-menu { display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-menu.show { display: flex; animation: slideUp 0.3s; }
        .fab-item {
            background: white; color: var(--text-light); padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 0.8rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
        }
        html.dark-mode .fab-item { background: #333; color: white; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ADMIN PIE CHART */
        .pie-chart {
            width: 150px; height: 150px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 50%, var(--danger) 50% 100%);
            margin: 20px auto; position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .pie-hole {
            width: 100px; height: 100px; background: var(--bg-light); border-radius: 50%;
            position: absolute; top: 25px; left: 25px;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; font-size: 0.8rem; font-weight: bold;
        }

        /* SKELETON LOADER (Shimmer) */
        .skeleton { 
            background: #eee;
            background-image: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            background-size: 200% 100%;
            animation: shimmer 1s linear infinite;
            border-radius: 8px; color: transparent !important; cursor: default;
        }
        html.dark-mode .skeleton { background: #333; background-image: linear-gradient(110deg, #2c2c2c 8%, #3a3a3a 18%, #2c2c2c 33%); }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        /* EMPTY STATE ICON */
        .empty-state { text-align: center; padding: 2rem; opacity: 0.6; }
        .empty-state i { font-size: 3rem; margin-bottom: 10px; color: #ccc; }

        /* OTHER UTILS */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Modal Updates */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--glass-surface); border: var(--glass-border); padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; color: var(--text-light); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        /* User Mgmt Styles (Preserved) */
        .user-mgmt-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--glass-surface); border: var(--glass-border); border-radius: 12px; margin-bottom: 10px; box-shadow: var(--shadow); transition: transform 0.2s; }
        .user-mgmt-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #999; }
        .user-mgmt-info { flex: 1; }
        .badge-admin { background: var(--primary); color: white; padding:2px 6px; border-radius:4px; font-size:0.7rem; }
        .badge-blocked { background: var(--danger); color: white; padding:2px 6px; border-radius:4px; font-size:0.7rem; }
        .action-icon-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 6px; box-shadow:none; width: auto; color: #666;}
        
        .reload-btn { font-size: 1rem; cursor: pointer; padding: 5px; animation: none; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOADING OVERLAY -->
    <div id="global-loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-light); z-index:999; display:flex; justify-content:center; align-items:center;">
        <div class="spinner" style="border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal" class="modal hidden" style="z-index: 2000; background: rgba(0,0,0,0.9);">
        <div class="modal-content text-center" style="background: white; color: #333;">
            <div class="onboarding-step active" id="step-1">
                <i class="fas fa-hand-holding-heart" style="font-size: 4rem; color: var(--accent); margin-bottom: 20px;"></i>
                <h3>Welcome to Al Ikhlas</h3>
                <p>Manage donations, find blood donors, and connect with your community.</p>
                <button onclick="nextOnboarding(2)" style="margin-top: 20px;">Next</button>
            </div>
            <div class="onboarding-step hidden" id="step-2">
                <i class="fas fa-tint" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
                <h3>Blood Bank</h3>
                <p>Request blood in emergencies or update your own eligibility status.</p>
                <button onclick="nextOnboarding(3)" style="margin-top: 20px;">Next</button>
            </div>
            <div class="onboarding-step hidden" id="step-3">
                <i class="fas fa-comments" style="font-size: 4rem; color: #2196f3; margin-bottom: 20px;"></i>
                <h3>Stay Connected</h3>
                <p>Chat with members and get instant notifications on important updates.</p>
                <button onclick="finishOnboarding()" style="margin-top: 20px;">Get Started</button>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="hidden">
        <!-- Help Link Added -->
        <a href="https://youtu.be/GLaForf5ltY?si=wtvDpxfc3dSqcprI" target="_blank" class="auth-help-link">
            <i class="fas fa-question-circle"></i> ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?
        </a>

        <div class="auth-box">
            <h2 class="text-primary" style="margin-bottom:10px;">‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ</h2>
            <p style="margin-bottom:20px; font-size:0.9rem; color:#666;">Organization Management System v1.2</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email Address" required>
                <input type="password" id="login-pass" placeholder="Password" required>
                <button type="submit">Login</button>
                <p style="margin-top:15px; font-size:0.8rem; color:#666;">Don't have an account? <a href="#" onclick="toggleAuthMode('register')" class="text-primary">Register</a></p>
            </form>
            <form id="register-form" class="hidden">
                <div style="text-align:center; margin-bottom:10px;">
                    <i class="fas fa-camera text-primary" style="font-size:2rem; cursor:pointer;" onclick="document.getElementById('reg-img').click()"></i>
                    <p style="font-size:0.7rem; color:#666;">Upload Photo</p>
                    <input type="file" id="reg-img" accept="image/*" class="hidden" onchange="previewRegImage(this)">
                    <img id="reg-img-preview" src="" style="width:60px; height:60px; border-radius:50%; display:none; margin:0 auto; object-fit:cover;">
                </div>
                <input type="text" id="reg-name" placeholder="Full Name" required>
                <input type="email" id="reg-email" placeholder="Email Address" required>
                <input type="password" id="reg-pass" placeholder="Password" required>
                <input type="tel" id="reg-phone" placeholder="Phone Number" required>
                <input type="text" id="reg-address" placeholder="Address">
                <select id="reg-blood">
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option><option value="A-">A-</option>
                    <option value="B+">B+</option><option value="B-">B-</option>
                    <option value="O+">O+</option><option value="O-">O-</option>
                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                </select>
                <input type="text" id="reg-fb" placeholder="Facebook Profile Link (Optional)">
                <button type="submit">Create Account</button>
                <p style="margin-top:15px; font-size:0.8rem; color:#666;">Already have an account? <a href="#" onclick="toggleAuthMode('login')" class="text-primary">Login</a></p>
            </form>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="app-interface" class="hidden">

        <header>
            <h1><span data-i18n="app_title">‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ</span> <span id="user-role-badge" style="font-size:0.7rem; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">User</span></h1>
            <div style="display:flex; align-items:center;">
<!-- Share Button -->
    <i class="fas fa-share-alt header-menu-btn" onclick="shareApp()" style="margin-right: 15px;" title="Share App"></i>
                
                <div style="position:relative; margin-right: 15px;">
                    <i class="fas fa-bell header-menu-btn" onclick="router('notifications', null)">
                        <span id="notif-badge" class="badge-count">0</span>
                    </i>
                </div>
                <i class="fas fa-ellipsis-v header-menu-btn" onclick="toggleMenu()"></i>
                
                <!-- HEADER MENU -->
                <div id="header-dropdown" class="dropdown-menu">
                    <div class="dropdown-item" onclick="window.open('https://www.appcreator24.com/app3927201-hqxpye', '_blank')">
                        <i class="fas fa-download"></i> <span data-i18n="menu_install">Install App</span>
                    </div>
                    <div class="dropdown-item" onclick="toggleLanguage()">
                        <i class="fas fa-language"></i> <span id="lang-toggle-text">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
                    </div>
                    <div class="dropdown-item" onclick="openModal('modal-about')"><i class="fas fa-info-circle"></i> <span data-i18n="menu_about">About Org</span></div>
                    <div class="dropdown-item" onclick="toggleDarkMode()">
                        <i class="fas fa-moon"></i> <span data-i18n="menu_dark">Dark Mode</span>
                        <i id="dark-mode-status" class="fas fa-toggle-off text-primary" style="margin-left:auto;"></i>
                    </div>
                    <div class="dropdown-item" onclick="showOnboarding()"><i class="fas fa-question-circle"></i> <span data-i18n="menu_help">Help Guide</span></div>
                    <div class="dropdown-item text-red" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="menu_logout">Logout</span></div>
                    <div style="padding:10px; font-size:0.7rem; color:#888; text-align:center;">App Version: v1.3.0</div>
                </div>
            </div>
        </header>
<!-- PULL TO REFRESH SPINNER -->
        <div id="ptr-container">
            <div class="ptr-icon"><i class="fas fa-sync-alt"></i></div>
        </div>
        <!-- FLOATING ACTION BUTTON -->
        <div class="fab-container">
            <div class="fab-main" onclick="toggleFab()">
                <i class="fas fa-plus" id="fab-icon"></i>
            </div>
            <div id="fab-menu" class="fab-menu">
                <div class="fab-item" onclick="toggleFab(); router('chat', document.querySelector('.nav-item:nth-child(3)'))">
                    <span>Chat</span> <i class="fas fa-comments text-primary"></i>
                </div>
                <div class="fab-item" onclick="toggleFab(); openModal('modal-blood')">
                    <span>Blood</span> <i class="fas fa-tint text-red"></i>
                </div>
                <div class="fab-item" onclick="toggleFab(); copyDonation()">
                    <span>Donate</span> <i class="fas fa-hand-holding-heart text-green"></i>
                </div>
            </div>
        </div>

        <!-- VIEW: HOME -->
        <div id="view-home" class="section">
            <!-- Stats Compact Grid -->
            <!-- Stats Compact Grid -->
            <div class="stats-grid">
                <div class="stat-card" onclick="openTransactionView('collection')" style="cursor:pointer; border-color: var(--success);">
                    <div class="stat-val" id="stat-funds">0‡ß≥</div>
                    <div class="stat-label" data-i18n="stat_collection">Collection</div>
                </div>
                <div class="stat-card" onclick="openTransactionView('expense')" style="cursor:pointer; border-color: var(--danger);">
                    <div class="stat-val text-red" id="stat-expense">0‡ß≥</div>
                    <div class="stat-label" data-i18n="stat_expense">Expense</div>
                </div>
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-val text-green" id="stat-balance">0‡ß≥</div>
                    <div class="stat-label" data-i18n="stat_balance">Balance</div>
                </div>
                <div class="stat-card" onclick="router('members', null)" style="cursor:pointer; border-color: #2196f3;">
                    <div class="stat-val" id="stat-members">0</div>
                    <div class="stat-label" data-i18n="stat_members">Members</div>
                </div>
            </div>

            <!-- Circular Monthly Goal -->
            <div class="card flex items-center justify-between" style="padding: 10px 15px;">
                <div style="flex:1;">
                    <h4 style="font-size: 0.9rem;" data-i18n="monthly_target">Monthly Target</h4>
                    <p id="monthly-progress-text" style="font-size:0.8rem; color:#666; margin-top:5px;">0 / 0‡ß≥</p>
                    <small class="admin-only text-primary" onclick="openModal('modal-target')" style="cursor:pointer; font-size: 0.7rem;" data-i18n="edit_target">Edit</small>
                </div>
                <div class="circular-progress">
                    <svg>
                        <circle cx="35" cy="35" r="30" class="progress-bg"></circle>
                        <circle cx="35" cy="35" r="30" class="progress-val" id="monthly-circle-bar" stroke-dasharray="188" stroke-dashoffset="188"></circle>
                    </svg>
                    <div class="progress-text" id="monthly-pct-text">0%</div>
                </div>
            </div>

            <!-- Donation Card -->
            <div class="card" style="border-left: 4px solid var(--success);">
                <div class="flex justify-between items-center">
                    <h4 data-i18n="btn_donate">ü§ù Donate Now</h4>
                    <i class="fas fa-edit admin-only text-primary" onclick="openModal('modal-donation-edit')" style="cursor:pointer;"></i>
                </div>
                <div class="donation-copy-box" style="background: rgba(0,0,0,0.03); padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border: 1px dashed var(--primary);">
                    <span>
                        <i class="fas fa-wallet text-primary"></i> 
                        <span id="display-donation-number" style="font-weight:600;">Loading...</span>
                    </span>
                    <i class="far fa-copy" onclick="copyDonation()" style="cursor:pointer; color:var(--primary);"></i>
                </div>
                <small style="opacity:0.7; display:block; margin-top:5px; text-align:center; font-size:0.75rem;">Send Money (bKash/Nagad)</small>
            </div>

            <div class="flex justify-between items-center" style="margin-bottom:10px; margin-top:15px;">
                <h3 data-i18n="header_notice">üìå Notice Board</h3>
                <div class="admin-only">
                    <button onclick="openModal('modal-notice')" class="secondary small-btn" data-i18n="btn_notice">+ Notice</button>
                </div>
            </div>
            
            <!-- Horizontal Swipeable Notice List -->
            <div id="notice-list">
                <!-- Content Injected via JS -->
            </div>
        </div>

        <!-- VIEW: BLOOD -->
        <div id="view-blood" class="section hidden">
            <h3 style="margin-bottom:10px;" data-i18n="header_blood">ü©∏ Blood Requests</h3>

            <div class="flex gap-2" style="margin-bottom: 15px;">
                <button onclick="openModal('modal-blood')" class="secondary w-full" data-i18n="btn_req_blood">+ Request Blood</button>
                <button onclick="filterBloodEligible()" id="btn-filter-eligible" class="secondary w-full" style="border-color:#ccc; color:#666;" data-i18n="btn_eligible_only">Eligible Only</button>
            </div>

            <div id="pending-blood-container" class="hidden">
                <h4 class="text-accent" style="margin:10px 0;">‚è≥ Pending Approval</h4>
                <div id="blood-pending-list"></div>
                <hr style="margin:20px 0; border:0; border-top:1px dashed #ccc;">
            </div>

            <h4 style="margin:10px 0;"><span data-i18n="header_active_req">Active Requests</span> <span id="active-blood-count" style="font-size:0.8rem; background:var(--primary); color:white; padding:2px 6px; border-radius:10px;">0</span></h4>
            <div id="blood-list"></div>
        </div>
         <!-- VIEW: TRANSACTIONS (Public) -->
        <div id="view-transactions" class="section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="public-trans-title">Transactions</h3>
                <button onclick="router('home', document.querySelector('.nav-item:nth-child(1)'))" class="small-btn secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
            <div id="public-trans-list">
                <!-- ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
            </div>
        </div>
        <!-- VIEW: MEMBERS DIRECTORY -->
        <div id="view-members" class="section hidden">
            <h3 data-i18n="header_members">üë• Member Directory</h3>
            <div class="flex gap-2" style="margin-bottom:15px;">
                <input type="text" id="member-search" placeholder="Search name..." onkeyup="filterMembers()" style="margin:0;">
                <select id="member-filter-blood" onchange="filterMembers()" style="width:100px; margin:0;">
                    <option value="All">All</option>
                    <option value="A+">A+</option><option value="A-">A-</option>
                    <option value="B+">B+</option><option value="B-">B-</option>
                    <option value="O+">O+</option><option value="O-">O-</option>
                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                </select>
            </div>
            <div id="members-list">
                <div class="spinner"></div>
            </div>
            <button id="btn-load-members" class="load-more-btn secondary small-btn" style="margin: 10px auto; display:block;" onclick="loadMembers(true)" data-i18n="btn_load_more">Load More</button>
        </div>

        <!-- VIEW: CHAT (Refactored for List & Room) -->
        <div id="view-chat" class="section hidden">
            
            <!-- LIST VIEW (Inbox) -->
            <div id="chat-list-view">
                <h3 style="padding:0 0 15px 5px;" data-i18n="nav_chat">üí¨ Messages</h3>
                <!-- Inbox List -->
                <div id="chat-inbox-list">
                    <!-- Community Chat Pinned -->
                    <div class="chat-list-item" onclick="openChatRoom('community', 'üì£ Community Chat', '')">
                        <div class="chat-avatar-container">
                            <div style="width:50px; height:50px; border-radius:50%; background:var(--primary-gradient); display:flex; align-items:center; justify-content:center; color:white; font-size:1.5rem;">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">Community Chat</span>
                            <span class="chat-preview">Tap to join general discussion</span>
                        </div>
                    </div>
                    <!-- Personal Chats will be injected here -->
                    <div id="private-chats-container"></div>
                </div>
            </div>

            <!-- ROOM VIEW (Conversation) -->
            <div id="chat-room-view" class="hidden">
                <div class="chat-pattern"></div>
                
                <!-- Room Header -->
                <div class="chat-room-header">
                    <i class="fas fa-arrow-left chat-back-btn" onclick="backToChatList()"></i>
                    <img id="room-avatar-img" src="" class="room-avatar">
                    <div class="room-info">
                        <h4 id="room-name-text">User Name</h4>
                        <p id="room-status-text">Offline</p>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-container">
                    <div id="pinned-message-container" style="background:var(--glass-surface); padding:8px; margin-bottom:5px; border-radius:10px; border:var(--glass-border); display:none; justify-content:space-between; align-items:center; cursor:pointer; width:100%;" onclick="scrollToPinned()">
                        <div style="font-size:0.8rem; color:var(--primary);"><i class="fas fa-thumbtack"></i> <span id="pinned-text-preview">Pinned Message</span></div>
                        <i class="fas fa-chevron-down" style="font-size:0.8rem;"></i>
                    </div>
                    
                    <div id="messages-list" style="flex:1;"></div>
                    
                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="typing-indicator hidden">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="chat-input-area">
                    <div id="reply-preview-bar" style="display:none; font-size:0.75rem; color:#666; margin-bottom:5px; width:100%; justify-content:space-between;">
                        <span>Replying to <b id="reply-to-name">Name</b></span>
                        <i class="fas fa-times" onclick="cancelReply()"></i>
                    </div>
                    <div style="flex:1; display:flex; gap:8px;">
                        <button onclick="document.getElementById('chat-img-input').click()" style="width:40px; height:40px; border-radius:50%; padding:0; background:#eee; color:#666; flex-shrink:0;"><i class="fas fa-camera"></i></button>
                        <input type="file" id="chat-img-input" accept="image/*" class="hidden" onchange="handleChatImageUpload(this)">
                        
                        <input type="text" id="chat-msg-input" placeholder="Type a message..." style="margin:0; border:none; border-radius:20px; padding:0 15px; background:#f0f2f5;">
                        
                        <button onclick="sendChat()" style="width:40px; height:40px; border-radius:50%; padding:0; flex-shrink:0;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: NOTIFICATIONS -->
        <div id="view-notifications" class="section hidden">
            <h3 data-i18n="header_notif">üîî Notifications</h3>
            <div class="flex justify-between" style="margin-bottom: 10px;">
                <small>Stay updated</small>
                <small class="text-primary" onclick="markAllNotificationsRead()" style="cursor:pointer;">Mark all read</small>
            </div>
            <div id="notification-list">
                <!-- Empty state handled in JS -->
            </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="view-admin" class="section hidden">
            <h3 data-i18n="header_admin">üõ†Ô∏è Admin Panel</h3>
            
            <!-- Pie Chart -->
            <div class="card" style="text-align:center;">
                <div id="admin-pie-chart" class="pie-chart">
                    <div class="pie-hole">
                        <span style="font-size:0.7rem; color:#888;">Balance</span>
                        <span id="chart-balance" class="text-primary">0‡ß≥</span>
                    </div>
                </div>
                <div class="flex justify-between" style="font-size:0.8rem; padding:0 20px;">
                    <span class="text-primary"><i class="fas fa-circle"></i> Income</span>
                    <span class="text-red"><i class="fas fa-circle"></i> Expense</span>
                </div>
            </div>

            <div class="stats-grid" style="margin-top:15px;">
                <button onclick="checkAdminAndOpen('modal-fund')" class="stat-card" style="border-color:var(--success); cursor:pointer;">
                    <i class="fas fa-hand-holding-dollar text-primary" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;" data-i18n="btn_add_fund">Add Collection</div>
                </button>
                <button onclick="checkAdminAndOpen('modal-expense')" class="stat-card" style="border-color:var(--danger); cursor:pointer;">
                    <i class="fas fa-file-invoice-dollar text-red" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;" data-i18n="btn_add_expense">Add Expense</div>
                </button>
                <button onclick="checkAdminAndOpen('modal-admin-about')" class="stat-card" style="border-color:var(--primary); cursor:pointer;">
                    <i class="fas fa-circle-info text-primary" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;">Edit About</div>
                </button>
                <button onclick="checkAdminAndOpen('modal-add-donor')" class="stat-card" style="border-color:var(--accent); cursor:pointer;">
                    <i class="fas fa-droplet text-red" style="font-size:1.5rem;"></i>
                    <div class="stat-label" style="margin-top:5px;">Add Donor</div>
                </button>
                <button onclick="openUserManagement()" class="stat-card" style="border-color:#2196F3; cursor:pointer;">
                    <i class="fas fa-users-cog text-primary" style="font-size:1.5rem; color:#2196F3 !important;"></i>
                    <div class="stat-label" style="margin-top:5px;">User Management</div>
                </button>
            </div>

            <div class="card">
                <h4>History</h4>
                <div id="fund-history-list" style="max-height:200px; overflow-y:auto; font-size:0.85rem;"></div>
            </div>
        </div>

        <!-- VIEW: PROFILE -->
        <div id="view-profile" class="section hidden">
            <div class="card text-center">
                <img id="profile-img-display" src="" class="profile-img-lg hidden" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent); margin-bottom: 10px;">
                <div id="profile-initial-display" style="width:100px; height:100px; background:#ddd; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2rem; color:#888;">
                    <i class="fas fa-user"></i>
                </div>

                <h3 id="profile-name">Loading...</h3>
                <span id="profile-blood-badge" style="background:#ffebee; color:var(--danger); padding:2px 8px; border-radius:12px; font-weight:bold; font-size:0.9rem;"></span>

                <div id="eligibility-container" style="margin: 10px 0;">
                    <span id="eligibility-badge" style="padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">Status Loading...</span>
                </div>

                <p id="profile-role" style="font-size:0.8rem; color:var(--primary); font-weight:600; margin-top:5px;"></p>
                <p id="profile-joined" style="font-size:0.75rem; opacity:0.6;">Joined: ...</p>

                <div style="margin: 15px 0; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px;">
                    <p id="profile-email" style="opacity:0.8; font-size:0.9rem; margin-bottom:5px;">...</p>
                    <p id="profile-address" style="opacity:0.8; font-size:0.9rem;">...</p>

                    <div id="profile-contact-actions" style="margin-top:15px; display:flex; justify-content:center; gap:15px; align-items:center;">
                        <!-- Message Button Added -->
                        <button id="btn-profile-msg" class="secondary hidden" style="width:auto; padding:8px 15px; border-radius:20px; font-size:0.9rem;">
                            <i class="fas fa-comment-dots"></i> Message
                        </button>
                        <a id="link-call" href="#" class="hidden" style="color:var(--primary); font-size:1.8rem;"><i class="fas fa-phone-square-alt"></i></a>
                        <a id="link-fb" href="#" target="_blank" class="hidden" style="color:#1877F2; font-size:1.8rem;"><i class="fab fa-facebook-square"></i></a>
                    </div>
                </div>

                <button id="btn-edit-profile" class="secondary hidden" onclick="openModal('modal-edit-profile')" style="margin-top:10px;" data-i18n="btn_edit_profile">Edit Profile</button>
            </div>
        </div>

        <!-- BOTTOM NAV (Compact) -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="router('home', this)">
                <i class="fas fa-home"></i> <span data-i18n="nav_home">Home</span>
            </div>
            <div class="nav-item" onclick="router('blood', this)">
                <div class="red-dot" id="blood-red-dot"></div>
                <i class="fas fa-tint"></i> <span data-i18n="nav_blood">Blood</span>
            </div>
            <div class="nav-item" onclick="router('chat', this)">
                <div class="badge-count" id="chat-unread-badge">0</div>
                <i class="fas fa-comments"></i> <span data-i18n="nav_chat">Chat</span>
            </div>
            <div class="nav-item admin-only" onclick="router('admin', this)">
                <i class="fas fa-shield-alt"></i> <span data-i18n="nav_admin">Admin</span>
            </div>
            <div class="nav-item" onclick="router('profile', this)">
                <i class="fas fa-user"></i> <span data-i18n="nav_profile">Profile</span>
            </div>
        </div>
    </div>

    <!-- VIEW: USER MANAGEMENT (Admin Only) -->
    <div id="view-user-management" class="section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3><i class="fas fa-users-cog text-primary"></i> User Management</h3>
            <button onclick="router('admin', document.querySelector('.nav-item.active'))" class="small-btn secondary">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
        <div class="search-filter-bar" style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
            <input type="text" id="user-search" placeholder="üîç Search users..." oninput="filterUsers()" style="margin:0;">
            <select id="role-filter" onchange="filterUsers()" style="margin:0; width:auto;">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="member">Member</option>
            </select>
            <select id="status-filter" onchange="filterUsers()" style="margin:0; width:auto;">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="blocked">Blocked</option>
            </select>
        </div>
        <div class="stats-grid" style="margin-bottom:15px;">
            <div class="stat-card"><div class="stat-val" id="total-users-count">0</div><div class="stat-label">Total</div></div>
            <div class="stat-card"><div class="stat-val" id="active-users-count">0</div><div class="stat-label">Active</div></div>
            <div class="stat-card"><div class="stat-val" id="blocked-users-count">0</div><div class="stat-label">Blocked</div></div>
            <div class="stat-card"><div class="stat-val" id="admin-count">0</div><div class="stat-label">Admins</div></div>
        </div>
        <div id="users-management-list"></div>
        <button id="btn-load-more-users" class="load-more-btn hidden secondary" onclick="loadMoreUsers()" style="margin:10px auto; display:block;">Load More Users</button>
    </div>

    <!-- MODALS -->
    <!-- Chat Image Preview Modal -->
    <div id="modal-chat-image-preview" class="modal hidden">
        <div class="modal-content text-center">
            <h3>Send Image?</h3>
            <img id="chat-preview-img-element" src="" style="max-width:100%; max-height:300px; border-radius:12px; margin:15px 0;">
            <div class="flex gap-2">
                <button onclick="confirmSendImage()">Send</button>
                <button class="secondary" onclick="closeModal('modal-chat-image-preview'); document.getElementById('chat-img-input').value = '';">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-about" class="modal hidden">
        <div class="modal-content text-center">
            <h2 class="text-primary">‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ</h2>
            <p style="font-size:0.9rem; color:#666; margin:10px 0;">Al Ikhlas Organization</p>
            <hr style="border:0; border-top:1px solid rgba(0,0,0,0.1); margin:10px 0;">
            <p id="about-display-text" style="white-space: pre-wrap; text-align: left; font-size: 0.9rem;">Loading...</p>
            <div id="about-social-icons" style="margin-top:15px; font-size:1.5rem; display:flex; justify-content:center; gap:15px; color:var(--primary);"></div>
            <br>
            <button onclick="closeModal('modal-about')">Close</button>
        </div>
    </div>

    <div id="modal-admin-about" class="modal hidden">
        <div class="modal-content">
            <h3>Edit About Section</h3>
            <textarea id="admin-about-text" rows="6" placeholder="Write about org..."></textarea>
            <h4 style="margin-top:10px;">Social Links</h4>
            <input type="text" id="admin-fb-link" placeholder="Facebook URL">
            <input type="text" id="admin-yt-link" placeholder="YouTube URL">
            <input type="text" id="admin-web-link" placeholder="Website URL">
            <div class="flex gap-2">
                <button onclick="saveAboutSettings()">Save</button>
                <button class="secondary" onclick="closeModal('modal-admin-about')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-target" class="modal hidden">
        <div class="modal-content">
            <h3>Monthly Target</h3>
            <input type="number" id="admin-target-amount" placeholder="Target Amount (BDT)">
            <div class="flex gap-2">
                <button onclick="saveMonthlyTarget()">Save</button>
                <button class="secondary" onclick="closeModal('modal-target')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-add-donor" class="modal hidden">
        <div class="modal-content">
            <h3>Add Manual Donor</h3>
            <input type="text" id="donor-name" placeholder="Name">
            <select id="donor-group">
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
            </select>
            <input type="text" id="donor-address" placeholder="Address">
            <input type="tel" id="donor-phone" placeholder="Phone">
            <div class="flex gap-2">
                <button onclick="saveDonor()">Save Donor</button>
                <button class="secondary" onclick="closeModal('modal-add-donor')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-notice" class="modal hidden">
        <div class="modal-content">
            <h3>Post Notice</h3>
            <input type="text" id="notice-title" placeholder="Title">
            <textarea id="notice-content" rows="4" placeholder="Details..."></textarea>
            <input type="text" id="notice-yt" placeholder="YouTube Video URL (Optional)">
            <label style="font-size:0.8rem;">Attach Image (Optional):</label>
            <input type="file" id="notice-img" accept="image/*">
            <div class="flex gap-2">
                <button onclick="submitNotice()">Post</button>
                <button class="secondary" onclick="closeModal('modal-notice')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-blood" class="modal hidden">
        <div class="modal-content">
            <h3>Request Blood</h3>
            <p style="font-size:0.8rem; color:var(--danger); margin-bottom:10px;">* Requests need Admin approval.</p>
            <input type="text" id="blood-patient" placeholder="Patient Name">
            <select id="blood-group">
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
            </select>
            <input type="text" id="blood-hospital" placeholder="Hospital Name">
            <input type="tel" id="blood-contact" placeholder="Contact Number">
            <input type="text" id="blood-location" placeholder="Location (Area/City)">
            <div class="flex gap-2">
                <button onclick="submitBloodRequest()">Submit</button>
                <button class="secondary" onclick="closeModal('modal-blood')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-fund" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-green">Add Collection</h3>
            <input type="text" id="fund-name" placeholder="Member/Source Name">
            <input type="number" id="fund-amount" placeholder="Amount (BDT)">
            <div class="flex gap-2">
                <button onclick="submitFund('collection')">Save</button>
                <button class="secondary" onclick="closeModal('modal-fund')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-expense" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-red">Add Expense</h3>
            <input type="text" id="expense-name" placeholder="Expense Reason/Name">
            <input type="number" id="expense-amount" placeholder="Amount (BDT)">
            <div class="flex gap-2">
                <button onclick="submitFund('expense')" class="danger">Save</button>
                <button class="secondary" onclick="closeModal('modal-expense')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-transaction" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Transaction</h3>
            <input type="hidden" id="edit-trans-id">
            <input type="text" id="edit-trans-name" placeholder="Name/Source">
            <input type="number" id="edit-trans-amount" placeholder="Amount (BDT)">
            <div class="flex gap-2">
                <button onclick="saveEditedTransaction()">Update</button>
                <button class="danger" onclick="deleteTransaction()">Delete</button>
            </div>
            <button class="secondary" onclick="closeModal('modal-edit-transaction')" style="margin-top:10px;">Cancel</button>
        </div>
    </div>

    <div id="modal-edit-profile" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <label style="font-size:0.8rem;">Profile Picture</label>
            <input type="file" id="edit-profile-img" accept="image/*">
            <input type="text" id="edit-profile-name" placeholder="Full Name">
            <input type="text" id="edit-profile-address" placeholder="Address">
            <input type="tel" id="edit-profile-phone" placeholder="Phone">
            <input type="text" id="edit-profile-fb" placeholder="Facebook Link">

            <div style="margin: 15px 0; display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.05); padding:10px; border-radius:10px;">
                <span style="font-size:0.9rem;">Ready to Donate Blood?</span>
                <label class="switch">
                    <input type="checkbox" id="edit-blood-ready">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="flex gap-2">
                <button onclick="saveProfileChanges()">Update</button>
                <button class="secondary" onclick="closeModal('modal-edit-profile')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-donation-edit" class="modal hidden">
        <div class="modal-content">
            <h3>Update Donation Info</h3>
            <input type="text" id="admin-donation-number" placeholder="bKash/Nagad Number">
            <div class="flex gap-2">
                <button onclick="saveDonationSettings()">Save</button>
                <button class="secondary" onclick="closeModal('modal-donation-edit')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Mgmt Modals -->
    <div id="modal-edit-user-role" class="modal hidden">
        <div class="modal-content">
            <h3>Change User Role</h3>
            <input type="hidden" id="edit-role-user-id">
            <p style="margin-bottom:10px; font-size:0.9rem;">User: <strong id="edit-role-user-name"></strong></p>
            <select id="edit-role-select">
                <option value="member">Member</option>
                <option value="moderator">Moderator</option>
                <option value="admin">Admin</option>
                <option value="donor">Donor</option>
            </select>
            <div class="flex gap-2">
                <button onclick="saveUserRole()">Save Role</button>
                <button class="secondary" onclick="closeModal('modal-edit-user-role')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-block-user" class="modal hidden">
        <div class="modal-content">
            <h3 id="block-modal-title">Block User</h3>
            <input type="hidden" id="block-user-id">
            <p style="margin-bottom:10px; font-size:0.9rem;">User: <strong id="block-user-name"></strong></p>
            <p id="block-confirmation-text" style="font-size:0.85rem; opacity:0.8; margin-bottom:15px;"></p>
            <div class="flex gap-2">
                <button id="block-confirm-btn" class="danger" onclick="confirmBlockUser()">Block User</button>
                <button class="secondary" onclick="closeModal('modal-block-user')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-delete-user" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-red">‚ö†Ô∏è Delete User Account</h3>
            <input type="hidden" id="delete-user-id">
            <p style="margin-bottom:10px; font-size:0.9rem;">User: <strong id="delete-user-name"></strong></p>
            <p style="font-size:0.85rem; opacity:0.8; margin-bottom:10px; color:var(--danger);">This action cannot be undone! All user data will be permanently deleted.</p>
            <p style="font-size:0.8rem; margin-bottom:15px;">Type <strong>DELETE</strong> to confirm:</p>
            <input type="text" id="delete-confirmation-input" placeholder="Type DELETE">
            <div class="flex gap-2">
                <button class="danger" onclick="confirmDeleteUser()">Delete Permanently</button>
                <button class="secondary" onclick="closeModal('modal-delete-user')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-user-details" class="modal hidden">
        <div class="modal-content">
            <h3>User Details</h3>
            <div id="user-details-content" style="font-size:0.9rem;"></div>
            <button onclick="closeModal('modal-user-details')" style="margin-top:15px;" class="secondary">Close</button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" style="position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 200; width: 300px; text-align: center; pointer-events: none;"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, where, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update, get, query as rQuery, limitToLast, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZ_pL1E_x7UyWoDDKg0mo6h15CZZhPQhA",
            authDomain: "al-ikhlas-3bae4.firebaseapp.com",
            databaseURL: "https://al-ikhlas-3bae4-default-rtdb.firebaseio.com",
            projectId: "al-ikhlas-3bae4",
            storageBucket: "al-ikhlas-3bae4.firebasestorage.app",
            messagingSenderId: "87930570775",
            appId: "1:87930570775:web:e25035f7549b1391153452"
        };
        const IMGBB_API_KEY = "6323eec33d6a157e5ef302037869d699"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡ßü‡ßá ‡¶¶‡¶ø‡¶®
const rtdb = getDatabase(app, "https://al-ikhlas-3bae4-default-rtdb.firebaseio.com");

        let currentUser = null;
        let userData = {};
        let isAdmin = false;
        let replyData = null;
        let lastMemberDoc = null; 
        let lastNoticeDoc = null;
        let pinnedMessageId = null;
        let noticeScrollInterval = null;
        let tempChatImage = null; // Store image file before sending

        // CHAT VARIABLES
        let currentChatId = 'community'; // 'community' or 'uid1_uid2'
        let chatListener = null;
        let typingTimeout = null;

        // --- CORE UTILS ---
        window.toggleMenu = () => { document.getElementById('header-dropdown').classList.toggle('show'); }
        window.toggleFab = () => { document.getElementById('fab-menu').classList.toggle('show'); document.getElementById('fab-icon').classList.toggle('fa-plus'); document.getElementById('fab-icon').classList.toggle('fa-times'); }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header-menu-btn') && !e.target.closest('.dropdown-menu')) {
                document.getElementById('header-dropdown').classList.remove('show');
            }
            if (!e.target.closest('.fab-container')) {
                document.getElementById('fab-menu').classList.remove('show');
                document.getElementById('fab-icon').className = 'fas fa-plus';
            }
        });

        // --- TRANSLATION SYSTEM ---
        const translations = {
            app_title: { en: "Al Ikhlas", bn: "‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ" },
            menu_install: { en: "Install App", bn: "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®" },
            menu_about: { en: "About Org", bn: "‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá" },
            menu_dark: { en: "Dark Mode", bn: "‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°" },
            menu_help: { en: "Help Guide", bn: "‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø" },
            menu_logout: { en: "Logout", bn: "‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü" },
            nav_home: { en: "Home", bn: "‡¶π‡ßã‡¶Æ" },
            nav_blood: { en: "Blood", bn: "‡¶∞‡¶ï‡ßç‡¶§" },
            nav_chat: { en: "Chat", bn: "‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü" },
            nav_admin: { en: "Admin", bn: "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®" },
            nav_profile: { en: "Profile", bn: "‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤" },
            stat_collection: { en: "Collection", bn: "‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π" },
            stat_expense: { en: "Expense", bn: "‡¶ñ‡¶∞‡¶ö" },
            stat_balance: { en: "Balance", bn: "‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá" },
            stat_members: { en: "Members", bn: "‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø" },
            monthly_target: { en: "Monthly Target", bn: "‡¶è‡¶¨‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø" },
            edit_target: { en: "Edit", bn: "‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®" },
            btn_donate: { en: "ü§ù Donate Now", bn: "ü§ù ‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®" },
            header_notice: { en: "üìå Notice Board", bn: "üìå ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¨‡ßã‡¶∞‡ßç‡¶°" },
            btn_notice: { en: "+ Notice", bn: "+ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂" },
            btn_load_more: { en: "Load More", bn: "‡¶Ü‡¶∞‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" },
            header_blood: { en: "ü©∏ Blood Requests", bn: "ü©∏ ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß" },
            btn_req_blood: { en: "+ Request Blood", bn: "+ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®" },
            btn_eligible_only: { en: "Eligible Only", bn: "‡¶¶‡¶æ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ" },
            header_active_req: { en: "Active Requests", bn: "‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß" },
            header_members: { en: "üë• Member Directory", bn: "üë• ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ" },
            header_notif: { en: "üîî Notifications", bn: "üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®" },
            header_admin: { en: "üõ†Ô∏è Admin Panel", bn: "üõ†Ô∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤" },
            btn_add_fund: { en: "Add Collection", bn: "‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" },
            btn_add_expense: { en: "Add Expense", bn: "‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" },
            btn_edit_profile: { en: "Edit Profile", bn: "‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤" }
        };

        window.toggleLanguage = () => {
            const currentLang = localStorage.getItem('lang') || 'en';
            const newLang = currentLang === 'en' ? 'bn' : 'en';
            localStorage.setItem('lang', newLang);
            updateLanguage(newLang);
        };

        function updateLanguage(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[key] && translations[key][lang]) {
                    el.textContent = translations[key][lang];
                }
            });
            const toggleText = document.getElementById('lang-toggle-text');
            if(toggleText) {
                toggleText.textContent = lang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('lang') || 'en';
            updateLanguage(savedLang);
        });

        window.toggleDarkMode = () => {
            const html = document.documentElement;
            html.classList.toggle('dark-mode');
            const isDark = html.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateDarkModeIcon(isDark);
        }

        function updateDarkModeIcon(isDark) {
            document.getElementById('dark-mode-status').className = isDark ? 'fas fa-toggle-on text-primary' : 'fas fa-toggle-off text-primary';
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
            updateDarkModeIcon(true);
        }

        window.showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.style.cssText = "background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 30px; margin-top: 10px; font-size: 0.9rem; backdrop-filter: blur(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s;";
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
// --- SHARE APP LOGIC ---
        window.shareApp = async () => {
            // ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ø‡ßá ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ø‡¶æ‡¶¨‡ßá
            const shareData = {
                title: '‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ | Al Ikhlas Organization',
                text: '‡¶Ü‡¶≤ ‡¶á‡¶ñ‡¶≤‡¶æ‡¶õ ‡¶Ö‡¶∞‡ßç‡¶ó‡¶æ‡¶®‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶¶‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶π‡¶ú‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§',
                url: 'https://www.appcreator24.com/app3927201-hqxpye' // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
            };

            try {
                // ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ Web Share API ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá (‡¶Ø‡ßá‡¶Æ‡¶® ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶°‡ßá‡¶∏‡ßç‡¶ï‡¶ü‡¶™ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞), ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
                    await navigator.clipboard.writeText(shareData.url);
                    showToast("App link copied to clipboard!");
                }
            } catch (err) {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
                console.log('Share canceled or error:', err);
            }
        }
        window.toggleLoader = (show) => { document.getElementById('global-loader').style.display = show ? 'flex' : 'none'; }
        window.manualReload = () => {
            const btn = document.getElementById('btn-reload');
            btn.classList.add('spin');
            loadHomeData();
            setTimeout(() => btn.classList.remove('spin'), 1000);
        }

        async function compressImage(file) {
            if (!file.type.startsWith('image/')) return file;
            const bmp = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 800; 
            const scale = width / bmp.width;
            canvas.width = width;
            canvas.height = bmp.height * scale;
            ctx.drawImage(bmp, 0, 0, width, canvas.height);
            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.7)); 
        }

        async function uploadToImgBB(file) {
            const compressedFile = await compressImage(file);
            const formData = new FormData();
            formData.append("image", compressedFile);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const data = await res.json();
                return data.success ? data.data.url : null;
            } catch(e) { console.error(e); return null; }
        }

        window.router = (viewName, navEl, param = null) => {
            // ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï: ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶õ‡¶æ‡ßú‡¶æ ‡¶ï‡ßá‡¶â ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶¨‡ßá
            if (viewName === 'admin' && !isAdmin) {
                showToast("Access Denied! Only admins can view this.");
                return;
            }

            // Hide all sections
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            // Show target section
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            // Update Nav State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');

            // FAB Logic
            const fab = document.querySelector('.fab-container');
            if(viewName === 'home') {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
                document.getElementById('fab-menu').classList.remove('show');
                document.getElementById('fab-icon').className = 'fas fa-plus';
            }

            // Stop Home Auto-scroll
            if(viewName !== 'home' && noticeScrollInterval) clearInterval(noticeScrollInterval);

            // Load Data based on view
            if(viewName === 'home') loadHomeData();
            if(viewName === 'blood') loadBloodRequests();
            if(viewName === 'members') loadMembers(); 
            if(viewName === 'chat') { 
                // Default to Inbox List View
                document.getElementById('chat-list-view').classList.remove('hidden');
                document.getElementById('chat-room-view').classList.add('hidden');
                loadChatInbox();
                markChatRead();
            }
            if(viewName === 'admin') loadAdminData();
            if(viewName === 'profile') loadProfile(param);
            if(viewName === 'notifications') loadNotifications();
        }

        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('header-dropdown').classList.remove('show');
            document.getElementById('fab-menu').classList.remove('show');
            if(id === 'modal-admin-about') populateAdminAbout();
        }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.checkAdminAndOpen = (modalId) => { if(isAdmin) openModal(modalId); else showToast("Access Denied"); }

        // --- AUTH & ONBOARDING ---
        window.toggleAuthMode = (mode) => {
            if(mode === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        }

        window.previewRegImage = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('reg-img-preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const phone = document.getElementById('reg-phone').value;
            const blood = document.getElementById('reg-blood').value;
            const address = document.getElementById('reg-address').value;
            const fb = document.getElementById('reg-fb').value;
            const fileInput = document.getElementById('reg-img');

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const photoURL = fileInput.files[0] ? await uploadToImgBB(fileInput.files[0]) : "";

                await setDoc(doc(db, "users", cred.user.uid), {
                    name, email, phone, bloodGroup: blood, address,
                    profileImage: photoURL || "",
                    socialLinks: { facebook: fb },
                    role: "member",
                    status: "active",
                    bloodEligible: true,
                    hasCompletedOnboarding: false,
                    createdAt: serverTimestamp()
                });

                await updateProfile(cred.user, { displayName: name, photoURL: photoURL });
                showToast("Account Created!");
                window.location.reload();
            } catch (error) { showToast("Error: " + error.message); toggleLoader(false); }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } 
            catch (error) { showToast("Login Failed: " + error.message); toggleLoader(false); }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userSnap = await getDoc(doc(db, "users", user.uid));

                if (userSnap.exists()) {
                    userData = userSnap.data();
                    if(userData.status === 'blocked') {
                        showToast("Account blocked.");
                        await signOut(auth);
                        toggleLoader(false);
                        return;
                    }
                    isAdmin = userData.role === 'admin';
                    document.body.classList.toggle('is-admin', isAdmin);
                    document.getElementById('user-role-badge').textContent = isAdmin ? 'Admin' : 'Member';
                    if (userData.hasCompletedOnboarding === false) {
                        document.getElementById('onboarding-modal').classList.remove('hidden');
                    }
                    startHeartbeat();
                    setupNotificationListener();
                    setupPresenceSystem();
                    setTimeout(() => updateLanguage(localStorage.getItem('lang') || 'en'), 500);
                }

                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                router('home', document.querySelector('.nav-item.active'));

                // Initialize chat listeners only for inbox presence
                loadChatInbox(); 
                setupBloodNotification();
                fetchDonationSettings();
                loadAboutData();
                fetchMonthlyTarget();

            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
            toggleLoader(false);
        });

        window.handleLogout = () => { signOut(auth); window.location.reload(); }

        window.nextOnboarding = (step) => {
            document.querySelectorAll('.onboarding-step').forEach(el => el.classList.remove('active', 'hidden'));
            document.querySelectorAll('.onboarding-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById(`step-${step}`).classList.add('active');
        }
        window.finishOnboarding = async () => {
            document.getElementById('onboarding-modal').classList.add('hidden');
            if (currentUser) {
                await updateDoc(doc(db, "users", currentUser.uid), { hasCompletedOnboarding: true });
            }
        }
        window.showOnboarding = () => {
             document.querySelectorAll('.onboarding-step').forEach(el => el.classList.add('hidden'));
             document.getElementById('step-1').classList.remove('hidden');
             document.getElementById('onboarding-modal').classList.remove('hidden');
             document.getElementById('header-dropdown').classList.remove('show');
        }

        function startHeartbeat() {
            setInterval(() => {
                if (currentUser) {
                    updateDoc(doc(db, "users", currentUser.uid), { lastActive: serverTimestamp() });
                }
            }, 60000);
        }
        
        // PRESENCE SYSTEM
        function setupPresenceSystem() {
            const connectedRef = ref(rtdb, '.info/connected');
            const userStatusRef = ref(rtdb, 'status/' + currentUser.uid);

            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    onDisconnect(userStatusRef).set({ state: 'offline', last_changed: serverTimestamp() });
                    set(userStatusRef, { state: 'online', last_changed: serverTimestamp() });
                }
            });
        }

        async function fetchMonthlyTarget() {
            const snap = await getDoc(doc(db, "settings", "donationTarget"));
            const target = snap.exists() ? (snap.data().monthlyTarget || 0) : 0;
            return target;
        }

        async function loadHomeData() {
            const skeletonStats = '<div class="skeleton" style="height:20px; width:60px; margin:0 auto;"></div>';
            document.getElementById('stat-funds').innerHTML = skeletonStats;
            document.getElementById('stat-expense').innerHTML = skeletonStats;
            document.getElementById('stat-balance').innerHTML = skeletonStats;
            document.getElementById('stat-members').innerHTML = skeletonStats;

            const fundSnap = await getDocs(collection(db, "funds"));
            let totalCol = 0, totalExp = 0, monthCol = 0;
            const currentMonth = new Date().getMonth();

            fundSnap.forEach(d => {
                const val = d.data();
                const amt = Number(val.amount);
                if(val.type === 'expense') totalExp += amt;
                else {
                    totalCol += amt;
                    if(val.timestamp && new Date(val.timestamp.toDate()).getMonth() === currentMonth) monthCol += amt;
                }
            });

            document.getElementById('stat-funds').textContent = totalCol + "‡ß≥";
            document.getElementById('stat-expense').textContent = totalExp + "‡ß≥";
            document.getElementById('stat-balance').textContent = (totalCol - totalExp) + "‡ß≥";

            const userSnap = await getDocs(collection(db, "users")); 
            const donorSnap = await getDocs(query(collection(db, "donors"), where("status", "!=", "inactive"))); 
            document.getElementById('stat-members').textContent = userSnap.size + donorSnap.size;

            // Circular Progress Logic
            const target = await fetchMonthlyTarget();
            document.getElementById('monthly-progress-text').textContent = `${monthCol} / ${target}‡ß≥`;
            const pct = target > 0 ? Math.min(Math.round((monthCol / target) * 100), 100) : 0;
            
            // Circumference = 2 * PI * 30 ‚âà 188
            const circle = document.getElementById('monthly-circle-bar');
            const circumference = 188;
            const offset = circumference - (pct / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById('monthly-pct-text').textContent = `${pct}%`;

            // Notices Update (Carousel)
            lastNoticeDoc = null;
            const list = document.getElementById('notice-list');
            list.innerHTML = `
                <div class="card skeleton notice-card"></div>
                <div class="card skeleton notice-card"></div>
            `;
            loadMoreNotices();
        }

        window.loadMoreNotices = async () => {
            const list = document.getElementById('notice-list');
            
            let q = query(collection(db, "notices"), orderBy("timestamp", "desc"), limit(5));
            const snapshot = await getDocs(q);
            
            list.innerHTML = ''; // Clear skeleton

            if (snapshot.empty) {
                list.innerHTML = `
                    <div class="empty-state w-full">
                        <i class="far fa-folder-open"></i>
                        <p>No notices found</p>
                    </div>`;
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : '';

                let mediaHTML = '';
                if(data.youtubeUrl) {
                    let vidId = null;
                    const url = data.youtubeUrl;
                    if(url.includes('v=')) vidId = url.split('v=')[1].split('&')[0].split('?')[0];
                    else if(url.includes('youtu.be/')) vidId = url.split('youtu.be/')[1].split('?')[0].split('&')[0];
                    else vidId = url.split('/').pop().split('?')[0].split('&')[0];

                    if(vidId) mediaHTML += `<div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 10px; background: #000; border-radius:12px;"><iframe src="https://www.youtube.com/embed/${vidId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;"></iframe></div>`;
                }
                if(data.imageUrl) {
                    mediaHTML += `<img src="${data.imageUrl}" loading="lazy" style="width:100%; border-radius:8px; margin-bottom:10px;">`;
                }

                const deleteBtn = isAdmin ? `<i class="fas fa-trash text-red" style="float:right; cursor:pointer;" onclick="deleteNotice('${doc.id}')"></i>` : '';

                const div = document.createElement('div');
                div.className = "card notice-card";
                div.innerHTML = `
                    <div class="flex justify-between items-center" style="margin-bottom:5px;">
                        <h4 style="color:var(--primary)">${data.title}</h4>
                        <small style="opacity:0.6">${date}</small>
                    </div>
                    ${mediaHTML}
                    <p style="font-size:0.9rem; opacity:0.8; white-space: pre-wrap;">${data.content}</p>
                    ${deleteBtn}
                `;
                list.appendChild(div);
            });

            // Auto-scroll Logic
            if(noticeScrollInterval) clearInterval(noticeScrollInterval);
            noticeScrollInterval = setInterval(() => {
                const cardWidth = list.querySelector('.notice-card')?.offsetWidth + 10 || 0;
                if(list.scrollLeft + list.offsetWidth >= list.scrollWidth) {
                    list.scrollTo({left: 0, behavior: 'smooth'});
                } else {
                    list.scrollBy({left: cardWidth, behavior: 'smooth'});
                }
            }, 3000); // 3 seconds
        }

        window.saveMonthlyTarget = async () => {
            const amt = document.getElementById('admin-target-amount').value;
            await setDoc(doc(db, "settings", "donationTarget"), { monthlyTarget: Number(amt) });
            showToast("Target Updated");
            closeModal('modal-target');
            loadHomeData();
        }

        window.submitNotice = async () => {
            const title = document.getElementById('notice-title').value;
            const content = document.getElementById('notice-content').value;
            const yt = document.getElementById('notice-yt').value;
            const imgInput = document.getElementById('notice-img');

            if(!title || !content) return showToast("Required fields missing");

            toggleLoader(true);
            const imageUrl = imgInput.files[0] ? await uploadToImgBB(imgInput.files[0]) : null;

            await addDoc(collection(db, "notices"), { title, content, youtubeUrl: yt || null, imageUrl, timestamp: serverTimestamp(), author: currentUser.uid });
            showToast("Notice Posted!");
            closeModal('modal-notice');
            sendNotificationToAll("New Notice", title, "notice");
            loadHomeData();
            toggleLoader(false);
        }

        window.deleteNotice = async(id) => { if(confirm("Delete?")) { await deleteDoc(doc(db, "notices", id)); loadHomeData(); } }

        function setupBloodNotification() {
            onSnapshot(query(collection(db, "bloodRequests"), where("approved", "==", false)), (snap) => {
                document.getElementById('blood-red-dot').className = snap.size > 0 ? 'red-dot visible' : 'red-dot';
            });
        }

        async function loadBloodRequests(filterEligible = false) {
            const list = document.getElementById('blood-list');
            list.innerHTML = '';
            document.getElementById('blood-pending-list').innerHTML = '';

            let activeCount = 0;
            const q = query(collection(db, "bloodRequests"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            const now = Date.now();
            let hasPending = false;

            if (snap.empty) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-heart-broken"></i>
                        <p>No active requests</p>
                    </div>`;
            }

            snap.forEach(async (docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;

                if (data.status !== 'Expired' && data.status !== 'Completed') {
                     if (now - (data.timestamp?.toMillis() || 0) > 72 * 60 * 60 * 1000) {
                         await updateDoc(doc(db, "bloodRequests", id), { status: 'Expired' });
                         data.status = 'Expired';
                     }
                }

                const isMine = data.createdBy === currentUser.uid;
                if (!isAdmin && !isMine && (data.status === 'Expired' || data.status === 'Completed')) return;

                if (data.approved) {
                    if (data.status !== 'Expired' && data.status !== 'Completed') activeCount++;
                    renderBloodCard(id, data, list, false);
                } else if (isAdmin || isMine) {
                    hasPending = true;
                    renderBloodCard(id, data, document.getElementById('blood-pending-list'), true);
                }
            });

            document.getElementById('active-blood-count').textContent = activeCount;
            document.getElementById('pending-blood-container').classList.toggle('hidden', !hasPending);
        }

        function renderBloodCard(id, data, container, isPending) {
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.location)}`;
            const div = document.createElement('div');
            div.className = "card blood-card";
            div.innerHTML = `
                <span class="blood-badge badge-${data.status}">${data.status}</span>
                <div class="blood-group"><span>${data.bloodGroup}</span></div>
                <div style="overflow:hidden; margin-left: 60px;">
                    <h4 style="font-size:1rem;">${data.hospital}</h4>
                    <p style="font-size:0.8rem; opacity:0.7;">Pt: ${data.patient}</p>
                    <a href="${mapLink}" target="_blank" style="font-size:0.8rem; color:#666; display:block; margin:5px 0;">
                        <i class="fas fa-map-marker-alt text-red"></i> ${data.location}
                    </a>
                    ${!isPending && data.status === 'Urgent' ? `<a href="tel:${data.contact}" style="display:inline-block; margin-top:5px; font-weight:600; color:var(--primary); text-decoration:none;"><i class="fas fa-phone"></i> Call</a>` : ''}
                    <div style="margin-top:10px; border-top:1px solid rgba(0,0,0,0.1); padding-top:5px; text-align:right;">
                        ${(isAdmin && isPending) ? `<button onclick="updateBloodStatus('${id}', 'approve')" style="font-size:0.7rem; width:auto; background:green;">Approve</button> <button onclick="updateBloodStatus('${id}', 'reject')" style="font-size:0.7rem; width:auto; background:red;">Reject</button>` : ''}
                        ${(data.createdBy === currentUser.uid || isAdmin) && data.status === 'Urgent' ? `<button onclick="updateBloodStatus('${id}', 'complete')" style="font-size:0.7rem; width:auto;">Mark Done</button>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        window.submitBloodRequest = async () => {
            const data = {
                patient: document.getElementById('blood-patient').value,
                bloodGroup: document.getElementById('blood-group').value,
                hospital: document.getElementById('blood-hospital').value,
                contact: document.getElementById('blood-contact').value,
                location: document.getElementById('blood-location').value,
                status: 'Pending', approved: false, createdBy: currentUser.uid, timestamp: serverTimestamp()
            };
            await addDoc(collection(db, "bloodRequests"), data);
            showToast("Request Submitted");
            closeModal('modal-blood');
            sendNotificationToAll("New Blood Request", `Blood Needed: ${data.bloodGroup}`, "blood", true);
            loadBloodRequests();
        }

        window.updateBloodStatus = async (id, action) => {
            const ref = doc(db, "bloodRequests", id);
            if(action === 'approve') await updateDoc(ref, { approved: true, status: 'Urgent', approvedBy: currentUser.uid });
            if(action === 'reject') await deleteDoc(ref);
            if(action === 'complete') await updateDoc(ref, { status: 'Completed' });
            loadBloodRequests();
        }

        window.filterBloodEligible = () => {
            showToast("Showing requests matching eligible donors...");
        }
// --- PUBLIC TRANSACTION VIEW LOGIC ---
        window.openTransactionView = async (type) => {
            // ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶™‡ßá‡¶ú ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá Transaction ‡¶™‡ßá‡¶ú ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-transactions').classList.remove('hidden');
            
            // ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            const titleEl = document.getElementById('public-trans-title');
            if(type === 'collection') {
                titleEl.innerHTML = '<i class="fas fa-hand-holding-dollar text-green"></i> Collection List';
            } else {
                titleEl.innerHTML = '<i class="fas fa-file-invoice-dollar text-red"></i> Expense List';
            }

            const list = document.getElementById('public-trans-list');
            list.innerHTML = `
                <div class="skeleton" style="height:60px; margin-bottom:10px;"></div>
                <div class="skeleton" style="height:60px; margin-bottom:10px;"></div>
                <div class="skeleton" style="height:60px; margin-bottom:10px;"></div>
            `;

            try {
                // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶ ‡¶ü‡¶ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶®‡¶æ (‡¶Ø‡ßá‡¶® ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶≤‡ßã‡¶° ‡¶π‡ßü)
                const q = query(collection(db, "funds"), orderBy("timestamp", "desc"), limit(100));
                const snap = await getDocs(q);
                
                list.innerHTML = '';
                let hasData = false;

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    
                    // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶ü‡¶æ‡¶á‡¶™‡ßá‡¶∞ (Collection/Expense) ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                    if(d.type === type || (type === 'collection' && d.type !== 'expense')) {
                        hasData = true;
                        const color = type === 'expense' ? 'var(--danger)' : 'var(--success)';
                        const sign = type === 'expense' ? '-' : '+';
                        const dateStr = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleDateString() : 'N/A';
                        
                        const div = document.createElement('div');
                        div.className = 'card flex items-center justify-between';
                        div.style.marginBottom = '10px';
                        div.style.borderLeft = `4px solid ${color}`;
                        
                        // ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶è‡¶°‡¶ø‡¶ü ‡¶¨‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡¶®‡¶ø
                        div.innerHTML = `
                            <div>
                                <h4 style="margin:0; font-size:1rem;">${d.name}</h4>
                                <small style="color:#888;">${dateStr}</small>
                            </div>
                            <div style="font-weight:bold; color:${color}; font-size:1.1rem;">
                                ${sign}${d.amount}‡ß≥
                            </div>
                        `;
                        list.appendChild(div);
                    }
                });

                if(!hasData) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>No records found</p></div>`;
                }

            } catch (error) {
                console.error("Error fetching transactions:", error);
                list.innerHTML = `<p class="text-center text-red">Error loading data. Check connection.</p>`;
            }
        };
        async function loadMembers(isLoadMore = false) {
            const list = document.getElementById('members-list');

            if(!isLoadMore) {
                list.innerHTML = '';
                lastMemberDoc = null;
                for(let i=0; i<3; i++) {
                    list.innerHTML += `
                        <div class="card flex items-center gap-2">
                            <div class="skeleton" style="width:50px; height:50px; border-radius:50%;"></div>
                            <div style="flex:1;">
                                <div class="skeleton" style="width:60%; height:15px; margin-bottom:5px;"></div>
                                <div class="skeleton" style="width:40%; height:15px;"></div>
                            </div>
                        </div>
                    `;
                }
            }

            let q = query(collection(db, "users"), orderBy("name"), limit(10));
            if(lastMemberDoc) q = query(collection(db, "users"), orderBy("name"), startAfter(lastMemberDoc), limit(10));

            const snap = await getDocs(q);

            if(!isLoadMore) list.innerHTML = ''; 

            if(snap.empty) {
                document.getElementById('btn-load-members').style.display = 'none';
                if(!isLoadMore) list.innerHTML = "<p class='text-center'>No members found.</p>";
                return;
            }

            lastMemberDoc = snap.docs[snap.docs.length - 1];
            document.getElementById('btn-load-members').style.display = 'block';

            snap.forEach(d => renderMemberCard(d.id, d.data(), list));

            if(!isLoadMore) {
                const dSnap = await getDocs(query(collection(db, "donors"), where("status", "!=", "inactive")));
                dSnap.forEach(d => renderMemberCard(d.id, {...d.data(), type: 'donor'}, list));
            }
        }

        function renderMemberCard(id, u, container) {
            const isOnline = u.lastActive && (Date.now() - u.lastActive.toMillis() < 5 * 60 * 1000);
            const statusColor = isOnline ? 'var(--success)' : '#ccc';
            const eligibleBadge = u.bloodEligible ? '<i class="fas fa-check-circle text-green" title="Ready"></i>' : '';

            container.innerHTML += `
                <div class="card member-card" data-name="${u.name.toLowerCase()}" data-blood="${u.bloodGroup || ''}" onclick="router('profile', null, '${id}')" style="cursor:pointer; padding:10px;">
                    <div class="flex items-center gap-2">
                        <img src="${u.profileImage || 'https://via.placeholder.com/50'}" loading="lazy" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid ${statusColor};">
                        <div style="flex:1;">
                            <h4 style="margin:0; font-size:1rem;">${u.name} ${eligibleBadge}</h4>
                            <div style="font-size:0.75rem; color:#666;">
                                ${u.bloodGroup || 'N/A'} ${u.type === 'donor' ? '(Donor)' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.filterMembers = () => {
            const term = document.getElementById('member-search').value.toLowerCase();
            const blood = document.getElementById('member-filter-blood').value;
            document.querySelectorAll('.member-card').forEach(el => {
                const name = el.getAttribute('data-name');
                const bGroup = el.getAttribute('data-blood');
                el.style.display = (name.includes(term) && (blood === 'All' || bGroup === blood)) ? 'block' : 'none';
            });
        }

        async function loadProfile(uid) {
            toggleLoader(true);
            const targetId = uid || currentUser.uid;
            let u, isOwn = (targetId === currentUser.uid);

            let docSnap = await getDoc(doc(db, "users", targetId));
            if(docSnap.exists()) u = docSnap.data();
            else {
                docSnap = await getDoc(doc(db, "donors", targetId));
                if(docSnap.exists()) u = docSnap.data();
            }

            if(u) {
                document.getElementById('profile-name').textContent = u.name;
                document.getElementById('profile-email').textContent = u.email || "Manual Donor";
                document.getElementById('profile-role').textContent = u.role ? u.role.toUpperCase() : "MEMBER";
                document.getElementById('profile-address').textContent = u.address || "";
                document.getElementById('profile-blood-badge').textContent = u.bloodGroup || "N/A";

                if(u.profileImage) {
                    document.getElementById('profile-img-display').src = u.profileImage;
                    document.getElementById('profile-img-display').classList.remove('hidden');
                    document.getElementById('profile-initial-display').classList.add('hidden');
                } else {
                    document.getElementById('profile-img-display').classList.add('hidden');
                    document.getElementById('profile-initial-display').classList.remove('hidden');
                }

                const dateStr = u.createdAt?.toDate ? u.createdAt.toDate().toLocaleDateString() : 'N/A';
                document.getElementById('profile-joined').textContent = "Joined: " + dateStr;

                const eligBadge = document.getElementById('eligibility-badge');
                if(u.bloodEligible) {
                    eligBadge.textContent = "Ready to Donate";
                    eligBadge.style.background = "#e8f5e9";
                    eligBadge.style.color = "#2e7d32";
                } else {
                    eligBadge.textContent = "Not Available";
                    eligBadge.style.background = "#ffebee";
                    eligBadge.style.color = "#c62828";
                }

                const btnEdit = document.getElementById('btn-edit-profile');
                if(isOwn) {
                    btnEdit.classList.remove('hidden');
                    document.getElementById('edit-blood-ready').checked = u.bloodEligible;
                } else btnEdit.classList.add('hidden');

                const linkCall = document.getElementById('link-call');
                if(u.phone) { linkCall.href = `tel:${u.phone}`; linkCall.classList.remove('hidden'); }
                const linkFb = document.getElementById('link-fb');
                if(u.socialLinks?.facebook) { linkFb.href = u.socialLinks.facebook; linkFb.classList.remove('hidden'); }

                // --- Message Button Logic ---
                const msgBtn = document.getElementById('btn-profile-msg');
                if(!isOwn) {
                    msgBtn.classList.remove('hidden');
                    msgBtn.onclick = () => {
                        // Open Chat Room immediately
                        openChatRoom(targetId, u.name, u.profileImage || '');
                    };
                } else {
                    msgBtn.classList.add('hidden');
                }
            }
            toggleLoader(false);
        }

        window.saveProfileChanges = async () => {
            toggleLoader(true);
            const name = document.getElementById('edit-profile-name').value || userData.name || "";
            const phone = document.getElementById('edit-profile-phone').value || userData.phone || "";
            const addr = document.getElementById('edit-profile-address').value || userData.address || "";
            
            const fbInput = document.getElementById('edit-profile-fb').value;
            const oldFb = (userData.socialLinks && userData.socialLinks.facebook) ? userData.socialLinks.facebook : "";
            const fb = fbInput || oldFb || "";

            const eligible = document.getElementById('edit-blood-ready').checked;
            const file = document.getElementById('edit-profile-img').files[0];

            let url = userData.profileImage || "";

            try {
                if(file) url = await uploadToImgBB(file);

                await updateDoc(doc(db, "users", currentUser.uid), {
                    name: name, 
                    phone: phone, 
                    address: addr, 
                    profileImage: url,
                    socialLinks: { facebook: fb },
                    bloodEligible: eligible
                });

                showToast("Profile Updated Successfully!");
                loadProfile(currentUser.uid);
                closeModal('modal-edit-profile');
            } catch (error) {
                console.error("Update Error:", error);
                showToast("Error: " + error.message);
            }

            toggleLoader(false);
        }

        // --- NEW CHAT SYSTEM LOGIC ---

        window.loadChatInbox = function() {
            if(!currentUser) return;
            const inboxContainer = document.getElementById('private-chats-container');
            const chatsRef = ref(rtdb, `user_chats/${currentUser.uid}`);
            
            // Listen for changes in user's chat list
            onValue(chatsRef, (snapshot) => {
                inboxContainer.innerHTML = '';
                const chats = [];
                snapshot.forEach(child => {
                    chats.push({ uid: child.key, ...child.val() });
                });

                // Sort by time
                chats.sort((a,b) => b.timestamp - a.timestamp);

                chats.forEach(chat => {
                    const time = new Date(chat.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const avatar = chat.pic || 'https://via.placeholder.com/50';
                    
                    const el = document.createElement('div');
                    el.className = 'chat-list-item';
                    el.onclick = () => openChatRoom(chat.uid, chat.name, chat.pic);
                    el.innerHTML = `
                        <div class="chat-avatar-container">
                            <img src="${avatar}" class="chat-avatar">
                            <!-- Status could be added here if needed -->
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">${chat.name}</span>
                            <span class="chat-preview">${chat.lastMsg}</span>
                        </div>
                        <span class="chat-time">${time}</span>
                    `;
                    inboxContainer.appendChild(el);
                });
            });
        }

        window.openChatRoom = async function(targetId, targetName, targetPic) {
    // ‡ßß. ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£
    if(targetId === 'community') {
        currentChatId = 'community';
    } else {
        const uid1 = currentUser.uid < targetId ? currentUser.uid : targetId;
        const uid2 = currentUser.uid < targetId ? targetId : currentUser.uid;
        currentChatId = `${uid1}_${uid2}`;
    }

    // ‡ß®. ‡¶≠‡¶ø‡¶â ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® (‡¶è‡¶ü‡¶æ‡¶á ‡¶Æ‡ßÇ‡¶≤ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏)
    // ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá router() ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶¨ ‡¶®‡¶æ, ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶∏‡ßá‡¶ü‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡ßü‡•§
    // ‡¶§‡¶æ‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶™‡ßá‡¶ú ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶ï‡¶∞‡¶¨‡•§
    
    // ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
    document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    document.getElementById('view-chat').classList.remove('hidden');

    // ‡ß©. ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    document.getElementById('chat-list-view').classList.add('hidden');
    document.getElementById('chat-room-view').classList.remove('hidden');
    
    // ‡ß™. ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelector('.nav-item:nth-child(3)').classList.add('active'); // ‡ß© ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ (‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü) ‡¶è‡¶ï‡¶ü‡¶ø‡¶≠ ‡¶π‡¶¨‡ßá

    // ‡ß´. ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶á‡¶®‡¶´‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.getElementById('room-name-text').textContent = targetName;
    const roomAvatar = document.getElementById('room-avatar-img');
    
    if(targetId === 'community') {
        roomAvatar.src = "https://cdn-icons-png.flaticon.com/512/33/33308.png"; 
        document.getElementById('room-status-text').textContent = "Official Group";
    } else {
        roomAvatar.src = targetPic || 'https://via.placeholder.com/50';
        
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
        const statusRef = ref(rtdb, `status/${targetId}`);
        onValue(statusRef, (snap) => {
            const status = snap.val();
            const statusText = document.getElementById('room-status-text');
            if(status && status.state === 'online') {
                statusText.textContent = "Active Now";
                statusText.style.color = "var(--success)";
            } else {
                statusText.textContent = "Offline";
                statusText.style.color = "#888";
            }
        });
    }

    // ‡ß¨. ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ï‡ßá‡¶ü‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
    subscribeToChatMessages(currentChatId);

    const typingRef = ref(rtdb, `typing/${currentChatId}`);
    onValue(typingRef, (snap) => {
        const typingData = snap.val();
        const indicator = document.getElementById('typing-indicator');
        let isTyping = false;
        if(typingData) {
            Object.keys(typingData).forEach(key => {
                if(key !== currentUser.uid && typingData[key]) isTyping = true;
            });
        }
        if(isTyping) indicator.classList.remove('hidden');
        else indicator.classList.add('hidden');
        scrollToBottomChat();
    });

    // ‡ß≠. ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
    const input = document.getElementById('chat-msg-input');
    input.oninput = () => {
        update(ref(rtdb, `typing/${currentChatId}`), { [currentUser.uid]: true });
        if(typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            update(ref(rtdb, `typing/${currentChatId}`), { [currentUser.uid]: false });
        }, 2000);
    };
}

        window.backToChatList = function() {
            document.getElementById('chat-room-view').classList.add('hidden');
            document.getElementById('chat-list-view').classList.remove('hidden');
            if(chatListener) {
                // Detach would be good here but simpler to just overwrite on next open
            }
            currentChatId = null;
        }

        function subscribeToChatMessages(chatId) {
            const list = document.getElementById('messages-list');
            list.innerHTML = ''; // Clear previous messages
            
            // Determine path: community goes to messages/community, private goes to messages/private/{chatId}
            const path = chatId === 'community' ? 'messages/community' : `messages/private/${chatId}`;
            const chatRef = ref(rtdb, path);

            // Detach previous listener if exists logic could be added here
            
            onChildAdded(chatRef, (snapshot) => {
                const msg = snapshot.val();
                if (msg.isPinned) updatePinnedUI(msg, snapshot.key);
                renderMessage(snapshot.key, msg);
                scrollToBottomChat();
            });

            onChildChanged(chatRef, (snapshot) => {
                 const msg = snapshot.val();
                 if (msg.isPinned) updatePinnedUI(msg, snapshot.key);
                 if (!msg.isPinned && pinnedMessageId === snapshot.key) {
                     document.getElementById('pinned-message-container').style.display = 'none';
                     pinnedMessageId = null;
                 }
            });
            
            onChildRemoved(chatRef, (snapshot) => {
                const msgEl = document.getElementById(`msg-${snapshot.key}`);
                if(msgEl) msgEl.remove();
            });
        }

        function updatePinnedUI(msg, key) {
            pinnedMessageId = key;
            const con = document.getElementById('pinned-message-container');
            const txt = document.getElementById('pinned-text-preview');
            con.style.display = 'flex';
            txt.textContent = msg.type === 'image' ? 'Pinned Image' : msg.text;
        }

        window.scrollToPinned = () => {
            if(pinnedMessageId) document.getElementById(`msg-${pinnedMessageId}`).scrollIntoView({behavior: "smooth"});
        }

        function markChatRead() {
            localStorage.setItem('lastSeenChat', Date.now());
            const badge = document.getElementById('chat-unread-badge');
            badge.textContent = '0';
            badge.style.display = 'none';
        }

        function createMessageHTML(key, msg) {
            const isMe = msg.uid === currentUser.uid;
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Avatar for other user messages
            const avatarHtml = !isMe ? `<img src="${msg.pic || 'https://via.placeholder.com/30'}" class="msg-avatar-small" onclick="router('profile', null, '${msg.uid}')">` : '';

            return `
                <div id="msg-${key}" class="msg-bubble ${isMe ? 'mine' : 'others'}" style="${msg.isAdmin ? 'border: 2px solid var(--accent);' : ''}">
                    ${avatarHtml}
                    ${!isMe ? `<span class="msg-name">${msg.name} ${msg.isAdmin ? '<i class="fas fa-crown text-accent"></i>' : ''}</span>` : ''}
                    
                    ${msg.replyTo ? `<div class="msg-reply-bar"><b>${msg.replyTo.name}</b>: ${msg.replyTo.text.substring(0,20)}...</div>` : ''}
                    
                    ${msg.type === 'image' ? `<img src="${msg.text}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open('${msg.text}')">` : `<span>${msg.text}</span>`}
                    
                    <div class="msg-meta">
                        ${isMe ? `<i class="fas fa-trash" style="cursor:pointer;" onclick="deleteMessage('${key}')"></i>` : ''}
                        <i class="fas fa-reply" style="cursor:pointer;" onclick="setReply('${key}', '${msg.name}', '${msg.type === 'image' ? 'Image' : msg.text.replace(/'/g, "\\'")}')"></i>
                        ${isAdmin ? `<i class="fas fa-thumbtack" style="cursor:pointer;" onclick="pinMessage('${key}')"></i>` : ''}
                        <span>${time}</span>
                    </div>
                </div>
            `;
        }

        function renderMessage(key, msg) {
            document.getElementById('messages-list').insertAdjacentHTML('beforeend', createMessageHTML(key, msg));
        }

        function scrollToBottomChat() {
            const list = document.getElementById('messages-container');
            list.scrollTop = list.scrollHeight;
        }

        window.sendChat = async () => {
            if(!currentChatId) return;
            const input = document.getElementById('chat-msg-input');
            const text = input.value;
            if(!text) return;

            const msgData = { 
                text, 
                type: 'text', 
                uid: currentUser.uid, 
                name: userData.name || "User", 
                pic: userData.profileImage || "",
                isAdmin, 
                timestamp: Date.now() 
            };
            
            if(replyData) msgData.replyTo = replyData;

            const path = currentChatId === 'community' ? 'messages/community' : `messages/private/${currentChatId}`;
            await push(ref(rtdb, path), msgData);

            // Update Inbox info for private chats
            if(currentChatId !== 'community') {
                updateInboxInfo(currentChatId, text);
            }

            input.value = '';
            cancelReply();
        }

        async function updateInboxInfo(chatId, lastMsgText) {
            const uids = chatId.split('_');
            const otherUid = uids[0] === currentUser.uid ? uids[1] : uids[0];
            
            // Get other user data just in case
            let otherName = "User";
            let otherPic = "";
            
            // Update My Inbox
            // We need other user's name/pic for my inbox view
            // This is simplified; ideally fetch from DB once. 
            // Here assuming we are inside openChatRoom so we have name in header
            const headerName = document.getElementById('room-name-text').textContent;
            const headerPic = document.getElementById('room-avatar-img').src;

            await update(ref(rtdb, `user_chats/${currentUser.uid}/${otherUid}`), {
                lastMsg: lastMsgText,
                timestamp: Date.now(),
                name: headerName,
                pic: headerPic,
                uid: otherUid
            });

            // Update Other's Inbox (So they see me)
            await update(ref(rtdb, `user_chats/${otherUid}/${currentUser.uid}`), {
                lastMsg: lastMsgText,
                timestamp: Date.now(),
                name: userData.name,
                pic: userData.profileImage || "",
                uid: currentUser.uid
            });
        }

        // Handle Image Pre-send Modal
        window.handleChatImageUpload = (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('chat-preview-img-element').src = e.target.result;
                    tempChatImage = file;
                    openModal('modal-chat-image-preview');
                };
                reader.readAsDataURL(file);
            }
        }

        window.confirmSendImage = async () => {
            if(!tempChatImage || !currentChatId) return;
            closeModal('modal-chat-image-preview');
            showToast("Uploading Image...");
            const url = await uploadToImgBB(tempChatImage);
            if(url) {
                const msgData = { 
                    text: url, 
                    type: 'image', 
                    uid: currentUser.uid, 
                    name: userData.name || "User", 
                    pic: userData.profileImage || "",
                    isAdmin, 
                    timestamp: Date.now() 
                };
                
                const path = currentChatId === 'community' ? 'messages/community' : `messages/private/${currentChatId}`;
                await push(ref(rtdb, path), msgData);

                if(currentChatId !== 'community') updateInboxInfo(currentChatId, "Sent an image");
            } else {
                showToast("Upload Failed");
            }
            tempChatImage = null;
            document.getElementById('chat-img-input').value = '';
        }

        window.pinMessage = async (key) => {
            if(!confirm("Pin this message?")) return;
            const path = currentChatId === 'community' ? 'messages/community' : `messages/private/${currentChatId}`;
            await update(ref(rtdb, `${path}/${key}`), { isPinned: true });
        }

        window.setReply = (msgKey, name, text) => {
            replyData = { msgKey, name, text };
            document.getElementById('reply-to-name').textContent = name;
            document.getElementById('reply-preview-bar').style.display = 'flex';
            document.getElementById('chat-msg-input').focus();
        }

        window.cancelReply = () => {
            replyData = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }

        window.deleteMessage = async (key) => {
            if(!confirm("Delete this message?")) return;
            try {
                const path = currentChatId === 'community' ? 'messages/community' : `messages/private/${currentChatId}`;
                await remove(ref(rtdb, `${path}/${key}`));
                const msgEl = document.getElementById(`msg-${key}`);
                if(msgEl) msgEl.remove();
                showToast("Message deleted");
            } catch(e) {
                showToast("Error deleting message");
                console.error(e);
            }
        }

        async function sendNotificationToAll(title, message, type, adminOnly = false) {
            // ‡ßß. ‡¶á‡¶®-‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ï‡ßã‡¶°)
            await addDoc(collection(db, "notifications"), {
                title, message, type, timestamp: serverTimestamp(), target: adminOnly ? 'admin' : 'all'
            });

            // ‡ß®. OneSignal ‡¶™‡ßÅ‡¶∂ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°)
            const oneSignalAppId = "09fa0ffd-e3bc-40e5-aef4-2d7bd0774c93"; 
            const restApiKey = "os_v2_app_bh5a77pdxraollxufv55a52msnpgfppy4gqeeifd23ksnf73gqxa5ilbf5yph34d3am7ipnb6urbhwvkf6nbxxwf4zmaomnf4iq6alq"; 

            const payload = {
                app_id: oneSignalAppId,
                included_segments:``,
                headings: { en: title },
                contents: { en: message }
            };

            try {
                await fetch("https://onesignal.com/api/v1/notifications", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                        "Authorization": "Basic " + restApiKey
                    },
                    body: JSON.stringify(payload)
                });
                console.log("Push Notification Sent Successfully!");
            } catch (e) {
                console.error("Push Notification Error:", e);
            }
        }

        function setupNotificationListener() {
            const q = query(collection(db, "notifications"), orderBy("timestamp", "desc"), limit(10));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('notification-list');
                list.innerHTML = '';
                let count = 0;
                
                if (snap.empty) {
                    list.innerHTML = `<div class="empty-state"><i class="far fa-bell"></i><p>No notifications</p></div>`;
                }

                snap.forEach(d => {
                    const data = d.data();
                    if(data.target === 'admin' && !isAdmin) return;

                    const isRead = localStorage.getItem(`notif_read_${d.id}`);
                    if(!isRead) count++;

                    const div = document.createElement('div');
                    div.style.cssText = `padding:12px; margin-bottom:10px; border-radius:12px; background:${isRead ? 'var(--glass-surface)' : 'rgba(56, 239, 125, 0.1)'}; border:var(--glass-border); border-left:4px solid ${isRead ? '#ccc' : 'var(--primary)'};`;
                    div.onclick = () => markRead(d.id);
                    div.innerHTML = `
                        <h5 style="margin-bottom:2px; font-weight:600;">${data.title}</h5>
                        <p style="font-size:0.8rem; color:var(--text-light); opacity:0.8;">${data.message}</p>
                    `;
                    list.appendChild(div);
                });

                const badge = document.getElementById('notif-badge');
                badge.textContent = count;
                badge.style.display = count > 0 ? 'block' : 'none';
            });
        }

        window.markRead = (id) => {
            localStorage.setItem(`notif_read_${id}`, 'true');
            setupNotificationListener();
        }

        window.loadNotifications = () => { setupNotificationListener(); }

        window.markAllNotificationsRead = () => {
            const list = document.getElementById('notification-list');
            document.getElementById('notif-badge').style.display = 'none';
            showToast("All marked as read");
        }

        window.saveDonor = async () => {
            const name = document.getElementById('donor-name').value;
            const group = document.getElementById('donor-group').value;
            const phone = document.getElementById('donor-phone').value;

            if(!name) return;
            await addDoc(collection(db, "donors"), { name, bloodGroup: group, phone, address: document.getElementById('donor-address').value, status: 'active', role: 'donor', createdAt: serverTimestamp() });
            showToast("Donor Added");
            closeModal('modal-add-donor');
        }

        window.saveAboutSettings = async () => {
             await setDoc(doc(db, "settings", "about"), {
                 text: document.getElementById('admin-about-text').value,
                 social: { facebook: document.getElementById('admin-fb-link').value, youtube: document.getElementById('admin-yt-link').value, website: document.getElementById('admin-web-link').value }
             });
             showToast("Saved");
             closeModal('modal-admin-about');
             loadAboutData();
        }

        async function loadAboutData(){
            const snap = await getDoc(doc(db, "settings", "about"));
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('about-display-text').textContent = d.text;
                let html = '';
                if(d.social?.facebook) html += `<a href="${d.social.facebook}" target="_blank"><i class="fab fa-facebook"></i></a>`;
                if(d.social?.youtube) html += `<a href="${d.social.youtube}" target="_blank"><i class="fab fa-youtube"></i></a>`;
                document.getElementById('about-social-icons').innerHTML = html;
            }
        }

        async function populateAdminAbout(){
            const snap = await getDoc(doc(db, "settings", "about"));
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('admin-about-text').value = d.text || "";
                document.getElementById('admin-fb-link').value = d.social?.facebook || "";
                document.getElementById('admin-yt-link').value = d.social?.youtube || "";
                document.getElementById('admin-web-link').value = d.social?.website || "";
            }
        }

        async function fetchDonationSettings() {
            const d = await getDoc(doc(db, "settings", "donation"));
            if(d.exists()) {
                document.getElementById('display-donation-number').textContent = d.data().number;
                if(document.getElementById('admin-donation-number')) document.getElementById('admin-donation-number').value = d.data().number;
            }
        }
        window.saveDonationSettings = async () => {
            await setDoc(doc(db, "settings", "donation"), { number: document.getElementById('admin-donation-number').value }, { merge: true });
            showToast("Saved");
            closeModal('modal-donation-edit');
            fetchDonationSettings();
        }
        window.copyDonation = () => { navigator.clipboard.writeText(document.getElementById('display-donation-number').textContent); showToast("Copied"); }

        window.submitFund = async (type) => {
            const id = type === 'expense' ? 'expense' : 'fund';
            await addDoc(collection(db, "funds"), { 
                name: document.getElementById(`${id}-name`).value, 
                amount: Number(document.getElementById(`${id}-amount`).value), 
                type: type, 
                timestamp: serverTimestamp() 
            });
            showToast("Saved");
            closeModal(`modal-${id}`);
            loadAdminData();
            loadHomeData();
        }

        async function loadAdminData() {
            const list = document.getElementById('fund-history-list');
            list.innerHTML = `
                <div class="skeleton" style="height:30px; margin-bottom:10px;"></div>
                <div class="skeleton" style="height:30px; margin-bottom:10px;"></div>
                <div class="skeleton" style="height:30px; margin-bottom:10px;"></div>
            `;

            const snap = await getDocs(query(collection(db, "funds"), orderBy("timestamp", "desc"), limit(20)));
            list.innerHTML = ''; 

            let totalInc = 0;
            let totalExp = 0;

            snap.forEach(docSnap => {
                 const d = docSnap.data();
                 const color = d.type === 'expense' ? 'red' : 'green';
                 const sign = d.type === 'expense' ? '-' : '+';
                 
                 if(d.type === 'expense') totalExp += Number(d.amount);
                 else totalInc += Number(d.amount);

                 const div = document.createElement('div');
                 div.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(0,0,0,0.05);";
                 div.innerHTML = `
                    <div style="flex:1">
                        <span style="font-weight:600;">${d.name}</span>
                        <br><small style="opacity:0.6">${new Date(d.timestamp?.toDate()).toLocaleDateString()}</small>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:${color}; font-weight:bold;">${sign}${d.amount}</span>
                        <i class="fas fa-edit text-primary" style="cursor:pointer;" 
                           onclick="openEditTransaction('${docSnap.id}', '${d.name}', '${d.amount}', '${d.type}')"></i>
                    </div>
                 `;
                 list.appendChild(div);
            });

            // Update Pie Chart
            const balance = totalInc - totalExp;
            document.getElementById('chart-balance').textContent = balance + '‡ß≥';
            
            const totalVolume = totalInc + totalExp;
            let incPct = 100;
            if(totalVolume > 0) {
                incPct = (totalInc / totalVolume) * 100;
            }
            
            const chart = document.getElementById('admin-pie-chart');
            const cGreen = '#11998e';
            const cRed = '#ff4b4b';
            chart.style.background = `conic-gradient(${cGreen} 0% ${incPct}%, ${cRed} ${incPct}% 100%)`;
        }

        window.openEditTransaction = (id, name, amount, type) => {
            document.getElementById('edit-trans-id').value = id;
            document.getElementById('edit-trans-name').value = name;
            document.getElementById('edit-trans-amount').value = amount;
            openModal('modal-edit-transaction');
        }

        window.saveEditedTransaction = async () => {
            const id = document.getElementById('edit-trans-id').value;
            const name = document.getElementById('edit-trans-name').value;
            const amount = Number(document.getElementById('edit-trans-amount').value);

            if(!name || !amount) return showToast("All fields required");

            toggleLoader(true);
            try {
                await updateDoc(doc(db, "funds", id), {
                    name: name,
                    amount: amount
                });
                showToast("Transaction Updated");
                closeModal('modal-edit-transaction');
                loadAdminData(); 
                loadHomeData();  
            } catch(e) {
                showToast("Error updating");
                console.error(e);
            }
            toggleLoader(false);
        }

        window.deleteTransaction = async () => {
            const id = document.getElementById('edit-trans-id').value;
            if(!confirm("Are you sure you want to delete this record?")) return;

            toggleLoader(true);
            try {
                await deleteDoc(doc(db, "funds", id));
                showToast("Record Deleted");
                closeModal('modal-edit-transaction');
                loadAdminData();
                loadHomeData();
            } catch(e) {
                showToast("Error deleting");
            }
            toggleLoader(false);
        }

        // ===== USER MANAGEMENT SYSTEM =====
        let allUsersData = [];
        let lastUserDoc = null;

        window.openUserManagement = () => {
            if(!isAdmin) {
                showToast("Access Denied");
                return;
            }
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-user-management').classList.remove('hidden');
            loadUsersList();
        }

        async function loadUsersList(loadMore = false) {
            const list = document.getElementById('users-management-list');

            if(!loadMore) {
                list.innerHTML = '<div class="skeleton" style="height:60px; margin-bottom:10px;"></div>'.repeat(3);
                lastUserDoc = null;
                allUsersData = [];
            }

            let q = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(20));
            if(lastUserDoc) {
                q = query(collection(db, "users"), orderBy("createdAt", "desc"), startAfter(lastUserDoc), limit(20));
            }

            const snap = await getDocs(q);

            if(!loadMore) list.innerHTML = '';

            if(snap.empty) {
                document.getElementById('btn-load-more-users').classList.add('hidden');
                if(!loadMore) list.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No users found</p></div>';
                return;
            }

            lastUserDoc = snap.docs[snap.docs.length - 1];

            snap.forEach(docSnap => {
                const userData = { id: docSnap.id, ...docSnap.data() };
                allUsersData.push(userData);
                renderUserCard(userData, list);
            });

            document.getElementById('btn-load-more-users').classList.remove('hidden');
            updateUserStats();
        }

        window.loadMoreUsers = () => loadUsersList(true);

        function renderUserCard(user, container) {
            const role = user.role || 'member';
            const status = user.status === 'blocked' ? 'blocked' : 'active';
            const joinDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';

            const card = document.createElement('div');
            card.className = 'user-mgmt-card';
            card.setAttribute('data-user-id', user.id);
            card.setAttribute('data-role', role);
            card.setAttribute('data-status', status);
            card.setAttribute('data-search-text', `${user.name} ${user.email} ${user.bloodGroup || ''}`.toLowerCase());

            const avatar = user.profileImage 
                ? `<img src="${user.profileImage}" class="user-mgmt-avatar" alt="${user.name}">`
                : `<div class="user-mgmt-avatar"><i class="fas fa-user"></i></div>`;

            card.innerHTML = `
                ${avatar}
                <div class="user-mgmt-info">
                    <div class="user-mgmt-name" style="font-weight:600;">${user.name || 'No Name'}</div>
                    <div class="user-mgmt-email" style="font-size:0.75rem; opacity:0.7;">${user.email}</div>
                    <div class="user-mgmt-meta" style="margin-top:4px;">
                        <span class="badge-admin" style="background:${role==='admin'?'var(--primary)':'#888'};">${role.toUpperCase()}</span>
                        ${status === 'blocked' ? '<span class="badge-blocked">BLOCKED</span>' : ''}
                        ${user.bloodGroup ? `<span style="font-size:0.7rem; background:#ffebee; color:#d32f2f; padding:2px 6px; border-radius:4px;">${user.bloodGroup}</span>` : ''}
                    </div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="action-icon-btn" onclick="openUserDetails('${user.id}')"><i class="fas fa-eye"></i></button>
                    <button class="action-icon-btn" onclick="openEditRole('${user.id}', '${user.name}', '${role}')"><i class="fas fa-user-tag text-primary"></i></button>
                    <button class="action-icon-btn" onclick="openBlockUser('${user.id}', '${user.name}', '${status}')"><i class="fas fa-${status === 'blocked' ? 'unlock' : 'ban'}" style="color:${status === 'blocked' ? 'green' : 'orange'};"></i></button>
                    <button class="action-icon-btn" onclick="openDeleteUser('${user.id}', '${user.name}')"><i class="fas fa-trash text-red"></i></button>
                </div>
            `;
            container.appendChild(card);
        }

        window.filterUsers = () => {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            document.querySelectorAll('.user-mgmt-card').forEach(card => {
                const text = card.getAttribute('data-search-text');
                const r = card.getAttribute('data-role');
                const s = card.getAttribute('data-status');
                const match = text.includes(searchTerm) && (!roleFilter || r === roleFilter) && (!statusFilter || s === statusFilter);
                card.style.display = match ? 'flex' : 'none';
            });
        }

        function updateUserStats() {
            const total = allUsersData.length;
            const active = allUsersData.filter(u => u.status !== 'blocked').length;
            const blocked = allUsersData.filter(u => u.status === 'blocked').length;
            const admins = allUsersData.filter(u => u.role === 'admin').length;
            document.getElementById('total-users-count').textContent = total;
            document.getElementById('active-users-count').textContent = active;
            document.getElementById('blocked-users-count').textContent = blocked;
            document.getElementById('admin-count').textContent = admins;
        }

        window.openEditRole = (userId, userName, currentRole) => {
            document.getElementById('edit-role-user-id').value = userId;
            document.getElementById('edit-role-user-name').textContent = userName;
            document.getElementById('edit-role-select').value = currentRole;
            openModal('modal-edit-user-role');
        }

        window.saveUserRole = async () => {
            const userId = document.getElementById('edit-role-user-id').value;
            const newRole = document.getElementById('edit-role-select').value;
            toggleLoader(true);
            try {
                await updateDoc(doc(db, "users", userId), { role: newRole });
                showToast("Role updated");
                closeModal('modal-edit-user-role');
                loadUsersList();
            } catch(e) { showToast("Error"); console.error(e); }
            toggleLoader(false);
        }

        window.openBlockUser = (userId, userName, currentStatus) => {
            document.getElementById('block-user-id').value = userId;
            document.getElementById('block-user-name').textContent = userName;
            const isBlocked = currentStatus === 'blocked';
            document.getElementById('block-modal-title').textContent = isBlocked ? 'Unblock User' : 'Block User';
            document.getElementById('block-confirmation-text').textContent = isBlocked ? 'User will regain access.' : 'User will lose access.';
            const btn = document.getElementById('block-confirm-btn');
            btn.textContent = isBlocked ? 'Unblock' : 'Block';
            btn.className = isBlocked ? 'success' : 'danger'; // Assuming success class exists or default
            if(isBlocked) btn.style.backgroundColor = 'var(--success)';
            openModal('modal-block-user');
        }

        window.confirmBlockUser = async () => {
            const userId = document.getElementById('block-user-id').value;
            // Get current status from local data to toggle
            const user = allUsersData.find(u => u.id === userId);
            const newStatus = user.status === 'blocked' ? 'active' : 'blocked';
            toggleLoader(true);
            try {
                await updateDoc(doc(db, "users", userId), { status: newStatus });
                showToast("Status updated");
                closeModal('modal-block-user');
                loadUsersList();
            } catch(e) { showToast("Error"); }
            toggleLoader(false);
        }

        window.openDeleteUser = (userId, userName) => {
            document.getElementById('delete-user-id').value = userId;
            document.getElementById('delete-user-name').textContent = userName;
            document.getElementById('delete-confirmation-input').value = '';
            openModal('modal-delete-user');
        }

        window.confirmDeleteUser = async () => {
            if(document.getElementById('delete-confirmation-input').value !== 'DELETE') return showToast("Type DELETE");
            const userId = document.getElementById('delete-user-id').value;
            toggleLoader(true);
            try {
                await deleteDoc(doc(db, "users", userId));
                showToast("User deleted");
                closeModal('modal-delete-user');
                loadUsersList();
            } catch(e) { showToast("Error"); }
            toggleLoader(false);
        }

        window.openUserDetails = async (userId) => {
            toggleLoader(true);
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if(userDoc.exists()) {
                    const user = userDoc.data();
                    const html = `
                        <div style="text-align:center; margin-bottom:15px;">
                            ${user.profileImage ? `<img src="${user.profileImage}" style="width:80px; height:80px; border-radius:50%; object-fit:cover;">` : '<i class="fas fa-user-circle fa-3x"></i>'}
                            <h4>${user.name}</h4>
                            <p>${user.email}</p>
                        </div>
                        <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                        <p><strong>Address:</strong> ${user.address || 'N/A'}</p>
                        <p><strong>Blood:</strong> ${user.bloodGroup || 'N/A'}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Joined:</strong> ${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                    `;
                    document.getElementById('user-details-content').innerHTML = html;
                    openModal('modal-user-details');
                }
            } catch(e) { console.error(e); }
            toggleLoader(false);
        }
// ===== PULL TO REFRESH (TOUCH & MOUSE LOGIC) =====
        let touchStartY = 0;
        let touchCurrentY = 0;
        let isPulling = false;
        const pullThreshold = 70; // ‡¶ï‡¶§‡¶ü‡ßÅ‡¶ï‡ßÅ ‡¶®‡¶ø‡¶ö‡ßá ‡¶ü‡¶æ‡¶®‡¶≤‡ßá ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶π‡¶¨‡ßá

        // ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ü‡¶æ‡¶ö ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü (‡¶è‡¶ñ‡¶æ‡¶®‡ßá e.touches ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 0) startPull(e.touches.clientY);
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0) movePull(e, e.touches.clientY);
        }, { passive: false });
        
        document.addEventListener('touchend', endPull);

        // ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶â‡¶∏ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü
        document.addEventListener('mousedown', (e) => startPull(e.clientY));
        document.addEventListener('mousemove', (e) => { if(isPulling) movePull(e, e.clientY) });
        document.addEventListener('mouseup', endPull);

        function startPull(clientY) {
            // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá (‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ß´ ‡¶™‡¶ø‡¶ï‡ßç‡¶∏‡ßá‡¶≤‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá)
            if (window.scrollY <= 5) {
                touchStartY = clientY;
                isPulling = true;
                const ptr = document.getElementById('ptr-container');
                if(ptr) ptr.style.transition = 'none'; 
            }
        }

        function movePull(e, clientY) {
            if (!isPulling) return;
            touchCurrentY = clientY;
            const pullDistance = touchCurrentY - touchStartY;

            if (pullDistance > 0 && window.scrollY <= 5) {
                const ptr = document.getElementById('ptr-container');
                if(ptr) {
                    let visualDistance = pullDistance * 0.4; 
                    if(visualDistance > 100) visualDistance = 100;
                    
                    ptr.style.opacity = Math.min(visualDistance / pullThreshold, 1);
                    ptr.style.transform = `translateY(${visualDistance - 50}px)`; // ‡¶®‡¶ø‡¶ö ‡¶¶‡¶ø‡¶ï‡ßá ‡¶®‡¶æ‡¶Æ‡¶¨‡ßá
                    
                    const icon = ptr.querySelector('i');
                    if(icon && !ptr.classList.contains('ptr-loading')) {
                        icon.style.transform = `rotate(${visualDistance * 3}deg)`; // ‡¶Ü‡¶á‡¶ï‡¶®‡¶ü‡¶ø ‡¶ò‡ßÅ‡¶∞‡¶¨‡ßá
                    }
                }
                if (e.cancelable) e.preventDefault(); 
            }
        }

        function endPull() {
            if (!isPulling) return;
            isPulling = false;
            const ptr = document.getElementById('ptr-container');
            const pullDistance = touchCurrentY - touchStartY;

            if (ptr) {
                ptr.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                
                if (pullDistance * 0.4 > pullThreshold && window.scrollY <= 5) {
                    ptr.classList.add('ptr-loading');
                    ptr.style.transform = `translateY(20px)`; 
                    
                    refreshActivePage(); // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶π‡¶¨‡ßá

                    // ‡ßß.‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
                    setTimeout(() => {
                        ptr.classList.remove('ptr-loading');
                        ptr.style.transform = 'translateY(-100px)';
                        ptr.style.opacity = '0';
                    }, 1500);
                } else {
                    // ‡¶Ö‡¶≤‡ßç‡¶™ ‡¶ü‡ßá‡¶®‡ßá ‡¶õ‡ßá‡ßú‡ßá ‡¶¶‡¶ø‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
                    ptr.style.transform = 'translateY(-100px)';
                    ptr.style.opacity = '0';
                }
            }
            touchStartY = 0;
            touchCurrentY = 0;
        }

        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶™‡ßá‡¶® ‡¶•‡¶æ‡¶ï‡¶æ ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.refreshActivePage = function() {
            if(!document.getElementById('view-home').classList.contains('hidden')) loadHomeData();
            if(!document.getElementById('view-blood').classList.contains('hidden')) loadBloodRequests();
            if(!document.getElementById('view-members').classList.contains('hidden')) loadMembers();
            if(!document.getElementById('view-admin').classList.contains('hidden')) loadAdminData();
            if(!document.getElementById('view-notifications').classList.contains('hidden')) loadNotifications();
            if(!document.getElementById('chat-list-view').classList.contains('hidden')) loadChatInbox();
        }
    </script>
</body>
</html>